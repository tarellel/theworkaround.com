<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Enhancing SSH Security - TheWorkAround</title>
  <meta name="google" content="notranslate">
  <meta name="robots" content="index, follow">
  <meta http-equiv="Content-Language" content="en">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Prefectch to Optimize Site Loading - src: http://csswizardry.com/ -->
  <link rel="preconnect" href="https://fonts.googleapis.com/" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com/" crossorigin>
  <link rel="preconnect" href="https://ajax.googleapis.com/" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com/" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com/">
  <link rel="dns-prefetch" href="https://www.google-analytics.com/">
  <link rel="dns-prefetch" href="https://ajax.googleapis.com/">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/">
  <meta name="theme-color" content="#4cb8c4">
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,400italic,500,500italic,700,700italic,300,300italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/assets/stylesheets/app-2f8dcde3ec3d31a47409c6e0384d17f6f14293be3c79175275a24b7d98786d35.css">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link href="/atom.xml" rel="alternate" title="Atom" type="application/atom+xml">
  <link href="/rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
  <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml">
  <link href="/humans.txt" rel="author" type="text/plain">
  <meta name='title' content='Enhancing SSH Security - TheWorkAround'>
  <meta name='og:title' content='Enhancing SSH Security - TheWorkAround'>
  <meta property='og:url' content='http://theworkaround.com/2016/11/11/enhancing-ssh-security.html'>

  <meta content="article" property="og:type">
  <meta name="author" content="Brandon Hicks">

  <meta name="description" content="SSH is an important multipurpose service, that we need to properly secure.">
  <meta name="keywords" content="security,ssh,terminal">

</head>
<body>
  <div class="container">
    <div class="site">
      <div class="row">
        <div class="col-md-2 text-right">
          <div class="social-icons">
          <p>
            <a href="/" title="Return to Homepage">/</a>
            <a href="http://twitter.com/tarellel" title="Follow me on Twitter" rel="me">
              <i class="fa fa-twitter"></i>
            </a>
            <a href="http://github.com/tarellel" title="View my code on GitHub" rel="me">
              <i class="fa fa-github"></i>
            </a>
            <a href="mailto:&#116;&#097;&#114;&#101;&#108;&#108;&#101;&#108;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;" title="Email Me" class="email">
              <i class="fa fa-envelope"></i>
            </a>
          </p>
          </div>
          <div class="text-right navlinks">
            <a href="/about">About</a><br/>
            <a href="/archive">Archive</a>
          </div>
        </div>
        <div class="col-md-10 content">
          <h2 class="post-title">Enhancing SSH Security</h2>
<div class="row">
  <div class="col-md-6">
    <p class="meta">Nov 11, 2016</p>
  </div>
  <div class="col-md-6 text-right">
    
      Tags: <a href="/tag/security/" rel="tag">security</a>, <a href="/tag/ssh/" rel="tag">ssh</a>, <a href="/tag/terminal/" rel="tag">terminal</a>
    
  </div>
</div>
<div class="post">
<p>With the whole security/privacy revolution rolling throughout the internet, it has recently come to my attention
that specific services are being heavily focused on, while others are completely neglected.
When securing your server and it’s services you need to attempt to secure the whole stack rather than a few specific services.
For example lets take a look at web servers, they’re full of new ideas and
technology, innovative, and always changing. And recently the world was recently introduced to <a href="https://letsencrypt.org/">Lets Encrypt</a>
which makes them and your data a magnitude of times more secure using HTTPS (when properly configured).</p>

<p>Another very important service that I’d like you to really think about is SSH.
It’s another service that we use for tons of uses, but you don’t think “Does it need secured”,
because everyone automatically seems to assume that it’s hardened by default.
But in my own words, I’d say “It’s easy to use by default, but not necessarily ready for use”.</p>

<p>I’m going to assume you’ve already hardened your SSH config with the basic settings (disable root login, AllowUsers, AllowGroups, MaxRetries, Fail2ban, LoginGraceTime, etc.) There’s tons of variable configurations to setup, one place I would suggest starting at would be <a href="http://tldp.org/LDP/solrhe/Securing-Optimizing-Linux-RH-Edition-v1.3/chap15sec122.html">Securing and Optimizing Linux</a> to get a basic configuration setup.</p>

<p>Now lets get to the main topic of this post, enhanced security.
Lately, I’ve seen quite a bit of talk suggesting everyone disable password
authentication and only using key and/or certificate encryptions to secure SSH connections.
I mean, really how probable is it that someone will be able to generate your exact ssh-key similar to the one below?</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC4MCqOxhfmNP/uv8sl5EYSIqQSGuV4v17B50xMWXMcwTJrriOi9W6nNfxF8wu/i2HB1/nUUuSu+ZxQdYaD2cRkelzSGcq191z+b8lNY2lz+bxB547H465U5EQPlxJ5w7WU6QOV1hrZ7quWh/GYrDnU1aZrhEQ++EV5chQIUxoP3YgBSSb8D5Bpns9gR0IZVtlEqhF8eyCypZSiyKumQxK8e/W8Y8iHWCtRfvZbh+bnemCkHrXI/xc+CuCY9TQmWZkwFfTRBJQo3pmoRSZAZpqwYSl1kySrasw771rfy2rowFiCogkBYu2W9FTR2kMwB4btBrpA4Af97AjxwzkHyXUt sample_user@gmail.com
</code></pre></div></div>

<p>Well, lets take a look how vulnerable your keys actually are.
If you’re like the vast majority of developers just using a <code class="highlighter-rouge">id_rsa.pub</code> or <code class="highlighter-rouge">id_dsa.pub</code> key for the vast majority of your logins and connections, than you may already be an easy target. You may be asking, how and why? Well let’s take a look at some keys people use with github.
If for example you use Github, or a number of services your public key is already out in the open. This is mainly for system wide user verification purposes. For example lets take a moment to look at user <a href="https://github.com/GrahamCampbell.keys">GrahamCampbell’s publickey</a>, now is his key is available what about <a href="https://gist.github.com/paulmillr/2657075/">everyone else’s</a>. If you still don’t trust me try it out with your own profile/username <a href="https://github.com/username.keys">https://github.com/username.keys</a>. Now tell me, how many services do you actually user ur id_rsa key with? If your using this one key for DigitalOcean, GitHub, Google Cloud, AWS, your companies servers, your local NAS, vagrant/Docker and who knows what else, than your services are ready for the taking. Now the simple questions is: How can we fix this?
Well, to begin we can begin by using the <a href="https://linux.die.net/man/5/ssh_config">ssh_config</a> file ‘~/.ssh/config’.
This allows us to assign the appropriate keys to be used when trying to access specific services/addresses.
This is part of the security method known as “security by obscurity”, you reduce the amount of parameters an attacker can access
by making things more complicated. If someone managers to get ahold of one of your keys, they won’t have access to every single web service you use.</p>

<p>An example of how of how you can specify ssh to connect to specific services:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host github.com
  user sample_user
  HostName github.com
  IdentityFile ~/.ssh/github_rsa
  IdentitiesOnly <span class="nb">yes

</span>Host digitalocean.com
  HostName digitalocean.com
  IdentityFile ~/.ssh/digitalocean_key
  IdentitiesOnly <span class="nb">yes

</span>And the list goes on...
</code></pre></div></div>

<p>Another step in order to make things a bit more complicated is to add a password to your SSH-keys.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-q</span> <span class="nt">-N</span> <span class="s1">'sample_password'</span> <span class="nt">-f</span> ~/.ssh/sample_id <span class="nt">-C</span> <span class="s2">"sample_user@gmail.com"</span>
</code></pre></div></div>

<p>You probably know by now, that by adding a password to your keys can be a pain in the butt.
Because every time you connect to a service or do a push request, etc. it’ll ask you for that crazy password you used <code class="highlighter-rouge">XL7pa5wnV/nQgUqi5mf7oQ6uG0hk5NwGh+5OYU+Mu6</code>. Well you can solve this by using a service such as <a href="http://www.funtoo.org/Keychain">keychain</a> and/or using your ssh-agent with the <a href="https://linux.die.net/man/1/ssh-add">ssh-add</a> command.
If configured properly, they require to only input the password once person login session.
So in other words, you won’t have to re-input your crazy password until your next reboot.</p>

<h3 id="newer-key-types">Newer Key types</h3>
<p>Another very important thing to look as is your key encryption method if your still using id_dsa and/or id_rsa, please update to using <a href="https://ed25519.cr.yp.to/">Ed25519</a> immediately. I admit, some services like GitHub and DigitalOcean may have issues when with this encryption type, but if your connecting to ssh I’d highly suggest it.
I’m no Cryptologist and I can’t tell you how and why a shorter key is more secure, other than it uses Elliptic curve cryptography methods.
But at the moment ED25519 is the recommended standard and as we know the higher the bit length and more rounds we encrypt the key, the more secure it’ll be.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-o</span> <span class="nt">-a</span> 100 <span class="nt">-b</span> 4096 <span class="nt">-t</span> ed25519 <span class="nt">-q</span> <span class="nt">-f</span> ~/.ssh/dev_key <span class="nt">-N</span> <span class="s1">'sample_password123'</span> <span class="nt">-C</span> <span class="s1">'sample_user'</span>

<span class="c"># ~/.ssh/dev_key</span>
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBCz0L+cnm3RSHawNK/h7hkCs7ZQIeeAyjKs4S+tHnPF sample_user
</code></pre></div></div>

<h3 id="duel-method-authentication">Duel Method Authentication</h3>
<p>Another enhancement you may wish to add to your SSH connections is requiring two forms of authentication.
This a technique in which you can also require a two methods of encryption in order to connect to the server (publickey and password).
In other words if a hacker “somehow” manages to get ahold of your publickey or your password, you’re server won’t be completely vulnerable to be victimized. Now let me warn you, this may cause issues with Capistrano, Ansible, Vagrant, or various other services.
Because the majority of them attempt to authenticate with the server by password or by publickey and not both.
But if that’s not that case and you’re really wanting to secure your SSH connections, this can be achieved with ease.
This is because we’ll be using <a href="https://www.kernel.org/pub/linux/libs/pam/whatispam.html">PAM</a> which should be fairly straight forward because most modern Linux installations have various PAM modules installed by default. This can be achieved by changing your AuthenticationMethods used in /etc/ssh/sshd_config to something similar to the following:</p>

<div class="language-config highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AuthenticationMethods</span> <span class="n">publickey</span>,<span class="n">keyboard</span>-<span class="n">interactive</span>:<span class="n">pam</span>
</code></pre></div></div>

<p>In other words, in order to connect the the specified server you will be required
to supply the proper publickey as well a valid password.
It also helps to enforce higher levels of encryption, using modern cyphers, and locking down specific users and/or groups.
If you’re looking to properly secure your SSH server, I suggest you begin is by taking a very thorough look at Mozilla’s <a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH">OpenSSH Guidelines</a>.</p>

<h3 id="important">Important</h3>
<p><strong><em>Please note</em></strong> that the methods suggested for securing your SSH in this post
are not the only methods required in order to properly secure your SSH server.
They mostly consist of method to enhance existing security methods for your SSH connections.</p>

<h3 id="references">References</h3>
<ul>
  <li><a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH">Mozilla SSH Guidelines</a></li>
</ul>

</div>


  <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//theworkaround.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



        </div>
      </div>
    </div>
  </div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41384218-1', 'theworkaround.com');
  ga('send', 'pageview');
</script>
</body>
</html>
