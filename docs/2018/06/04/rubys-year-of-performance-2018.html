<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Ruby’s Year of Performance (2018) | TheWorkAround</title> <meta name="generator" content="Jekyll v3.8.6"/> <meta property="og:title" content="Ruby’s Year of Performance (2018)"/> <meta name="author" content="Brandon Hicks"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="The infinate rambelings and ideas of Brandon Hicks"/> <meta property="og:description" content="The infinate rambelings and ideas of Brandon Hicks"/> <link rel="canonical" href="https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018.html"/> <meta property="og:url" content="https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018.html"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2018-06-04T00:00:00-06:00"/> <script type="application/ld+json">
{"description":"The infinate rambelings and ideas of Brandon Hicks","@type":"BlogPosting","url":"https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018.html","headline":"Ruby’s Year of Performance (2018)","dateModified":"2018-06-04T00:00:00-06:00","datePublished":"2018-06-04T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018.html"},"author":{"@type":"Person","name":"Brandon Hicks"},"@context":"https://schema.org"}</script> <meta name="title" content="Ruby's Year of Performance (2018) | TheWorkAround"> <meta name="keywords" content="performance,ruby"> <meta name="google" content="notranslate"> <meta name="robots" content="index, follow"> <meta http-equiv="Content-Language" content="en"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="preconnect" href="https://fonts.googleapis.com/" crossorigin> <link rel="preconnect" href="https://www.google-analytics.com/" crossorigin> <link rel="preconnect" href="https://ajax.googleapis.com/" crossorigin> <link rel="preconnect" href="https://cdnjs.cloudflare.com/" crossorigin> <link rel="dns-prefetch" href="https://fonts.googleapis.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/"> <meta name="theme-color" content="#4cb8c4"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous" defer="defer"> <link defer rel="stylesheet" integrity="sha256-pjvK/R2EEkAZiXPyxEJ/AZ72c6dW+ie2FpKgNDzMrpo=" crossorigin="anonymous" href="/assets/stylesheets/app-a63bcafd1d841240198973f2c4427f019ef673a756fa27b61692a0343cccae9a.css"> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--> <!--[if lte IE 8]><script src="https://cdnjs.cloudflare.com/ajax/libs/ie8/0.8.0/ie8.js"></script><![endif]--> <link href="/atom.xml" rel="alternate" title="Atom" type="application/atom+xml"> <link href="/rss.xml" rel="alternate" title="RSS" type="application/rss+xml"> <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="/humans.txt" rel="author" type="text/plain"> </head> <body> <div class="container-fluid"> <div class="site"> <div class="row"> <div class="col-md-2"> <div class="social-icons d-flex justify-content-around justify-content-md-end"> <a href="/" title="Return to Homepage" class="mx-2">/</a> <a href="http://twitter.com/tarellel" title="Follow me on Twitter" class="mx-2" rel="me"> <em class="fab fa-twitter"></em> </a> <a href="http://github.com/tarellel" title="View my code on GitHub" class="mx-2" rel="me"> <em class="fab fa-github"></em> </a> <a href="mailto:&#116;&#097;&#114;&#101;&#108;&#108;&#101;&#108;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;" title="Email Me" class="mx-2" rel="email"> <em class="fa fa-envelope"></em> </a> </div> <div class="text-right navlinks d-flex justify-content-around flex-md-column p-0 my-2"> <a href="/about" class="nav-items my-sm-3 my-md-0">About</a> <a href="/archive" class="nav-items my-sm-3 my-md-0">Archive</a> </div> </div> <div class="col-md-10 px-3"> <h1 class="post-title">Ruby's Year of Performance (2018)</h1> <div class="d-flex justify-content-between py-0 mb-xs-3"> <div class="meta">Jun 04, 2018</div> <div class="text-right"> Tags: <a href="/tag/performance/" rel="tag">performance</a>, <a href="/tag/ruby/" rel="tag">ruby</a> </div> </div> <div class="post"> <p>Many people claim Ruby is no longer relevant and quite a few people have moved on to Elixir, Go, Rust, and Node. This is because Ruby was not originally built for speed, it was built for ease of use. It does have its limitations and Rails is a monstrosity with all it’s services, workers, etc. But I’ve never had an issue with this, I started using Ruby because of its ease of use. I can from a world of using PHP and ugly spaghetti code to Ruby where coding is more of a thing of art.</p> <p>But 2018 has been a big year for Ruby releases and trying to meet their <a href="https://blog.heroku.com/ruby-3-by-3">3x3</a> performance goals (<a href="https://developers.redhat.com/blog/2018/03/22/ruby-3x3-performance-goal/">RedHat Writeup</a>). And in the last year alone, <a href="https://twitter.com/tenderlove">Arron Patterson (tenderlove)</a> and various contributors have made amazing advances in improving Ruby’s performance. And the addition of a <a href="https://www.ruby-lang.org/en/news/2018/05/31/ruby-2-6-0-preview2-released/">JIT compiler</a> to Ruby is no ease feat that looks like it will also have a HUGE effect on Ruby to regain some ground and no longer be known as a “slow language”. I admit <a href="https://github.com/oracle/truffleruby">Ruby Truffle</a> has some extreme potential to improve Rubys performance using the <a href="https://www.graalvm.org/">GraalVM</a> but since Oracle does have a tendency to take people to court and suing them, for using their various technological components.</p> <p>Another modification that I have found that dramatically improves performance and reduces memory usage is by adding <a href="http://jemalloc.net/">jemalloc</a>. By default, the MRI version uses the glibc memalloc library.</p> <p>To use jemalloc with ruby lets first install the library, so we can use it when compiling out ruby binaries.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OSx</span>
brew <span class="nb">install </span>jemalloc

<span class="c"># Ubuntu/Debian</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>libjemalloc1 libjemalloc-dev
</code></pre></div></div> <p>Many of people prefer <a href="https://github.com/rbenv/ruby-build">ruby-build</a> for compiling new ruby versions but I prefer <a href="https://rvm.io/">RVM</a> because of it’s ease of use. Now to compile with jemmalloc, we need to add the flags for RVM to compile using the jemalloc library.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm <span class="nb">install </span>2.5 <span class="nt">-C</span> <span class="nt">--with-jemalloc</span> <span class="nt">--autolibs</span><span class="o">=</span>disable
</code></pre></div></div> <p>I tend to use the <a href="https://fishshell.com/">Fish</a> shell, it has dramatically increased my productivity with its ease of use, auto completion libraries, and great features. So to make compiling a new RVM instance easier I created a function titled <code class="highlighter-rouge">rvm_install</code> so now when I want to compile a new Ruby version with the jemalloc flag I issue a command similar to the following <code class="highlighter-rouge">rvm_install 2.6</code> and wait. Below is a copy of the function I created, I know I should probably issue some validation to verify the value of the argument, but I’m the only one using this on my computer and it’s works wonders for what I need it for.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install the specified Ruby version through RVM, with the jemalloc library included</span>
<span class="k">function </span>rvm_install
  <span class="c"># verify a version number was specified</span>
  <span class="k">if </span>count <span class="nv">$argv</span> <span class="o">&gt;</span> /dev/null
    <span class="nb">echo</span> <span class="s2">"Installing Ruby-</span><span class="nv">$argv</span><span class="s2"> with jemalloc"</span>
    rvm <span class="nb">install</span> <span class="nv">$argv</span> <span class="nt">-C</span> <span class="nt">--with-jemalloc</span>
  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Please specify a version to install."</span>
  end
end
</code></pre></div></div> <p>Now lets take a look at a few Ruby versions to test how well they perform with and without jemalloc. Sam Saffron’s <a href="https://github.com/SamSaffron/allocator_bench/blob/master/stress_mem.rb">stress test</a> is a great way to compare performance gains and memory allocation. And let me reiterate that I didn’t just run this test a single time and compare the results. These use the averages after running each stress test several times.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Results for Ruby_v2.5.0p0</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">9.542045</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">137860</span>

<span class="c1"># Ruby_v2.5.0p0 with jemmalloc</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">7.420393</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">129616</span>

<span class="no">Faster</span> <span class="n">w</span><span class="o">/</span><span class="no">Jemalloc</span><span class="p">:</span>
<span class="mf">0.222347725251767</span> <span class="o">==&gt;</span> <span class="mi">22</span><span class="o">%</span> <span class="n">faster</span>


<span class="c1"># Ruby_v2.6.0-preview2 with jemalloc</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">6.743956</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">144108</span>

<span class="c1"># Faster than 2.5</span>
<span class="mf">0.09115918792980371</span> <span class="o">==&gt;</span> <span class="mi">9</span><span class="o">%</span> <span class="n">faster</span>
</code></pre></div></div> <p>As you can see, just adding jemalloc to MRI ruby adds quite a noticeable performance gain. And even when not using a different memory allocator, each new Ruby release has had quite a significant impact on building on the languages potential.</p> <p>~ <strong>NOTE:</strong> These tests are performed on a MBP with OSx 10.12, a 2.2ghz i7, 16GB of RAM, and a SSD. So the results may vary from device to device.</p> </div> <div id="disqus_thread"></div> <script>!function(){var e=document,t=e.createElement("script");t.src="//theworkaround.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-41384218-1","https://theworkaround.com"),ga("send","pageview");</script> </body> </html>