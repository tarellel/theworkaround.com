<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Using UUIDs in Rails | TheWorkAround</title> <meta name="generator" content="Jekyll v3.8.5"/> <meta property="og:title" content="Using UUIDs in Rails"/> <meta name="author" content="Brandon Hicks"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="A quick explanation on how to generate UUIDs in Rails while using the Postgres and SQLite databases"/> <meta property="og:description" content="A quick explanation on how to generate UUIDs in Rails while using the Postgres and SQLite databases"/> <link rel="canonical" href="http://theworkaround.com/2015/06/12/using-uuids-in-rails.html"/> <meta property="og:url" content="http://theworkaround.com/2015/06/12/using-uuids-in-rails.html"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2015-06-12T00:00:00-06:00"/> <script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://theworkaround.com/2015/06/12/using-uuids-in-rails.html"},"url":"http://theworkaround.com/2015/06/12/using-uuids-in-rails.html","headline":"Using UUIDs in Rails","dateModified":"2015-06-12T00:00:00-06:00","datePublished":"2015-06-12T00:00:00-06:00","description":"A quick explanation on how to generate UUIDs in Rails while using the Postgres and SQLite databases","author":{"@type":"Person","name":"Brandon Hicks"},"@type":"BlogPosting","@context":"https://schema.org"}</script> <meta name="title" content="Using UUIDs in Rails | TheWorkAround"> <meta name="keywords" content="database,development,rails,ruby"> <meta name="google" content="notranslate"> <meta name="robots" content="index, follow"> <meta http-equiv="Content-Language" content="en"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="preconnect" href="https://fonts.googleapis.com/" crossorigin> <link rel="preconnect" href="https://www.google-analytics.com/" crossorigin> <link rel="preconnect" href="https://ajax.googleapis.com/" crossorigin> <link rel="preconnect" href="https://cdnjs.cloudflare.com/" crossorigin> <link rel="dns-prefetch" href="https://fonts.googleapis.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/"> <meta name="theme-color" content="#4cb8c4"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous"> <link rel="stylesheet" href="/assets/stylesheets/app-a09f5d095871465ede6b58bcd69c865d37a9decae5f0de1f17b636e1913e8966.css" integrity="sha256-oJ9dCVhxRl7ea1i81pyGXTep3srl8N4fF7Y24ZE+iWY=" crossorigin="anonymous"> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--> <!--[if lte IE 8]><script src="https://cdnjs.cloudflare.com/ajax/libs/ie8/0.8.0/ie8.js"></script><![endif]--> <link href="/atom.xml" rel="alternate" title="Atom" type="application/atom+xml"> <link href="/rss.xml" rel="alternate" title="RSS" type="application/rss+xml"> <link href="/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="/humans.txt" rel="author" type="text/plain"> </head> <body> <div class="container-fluid"> <div class="site"> <div class="row"> <div class="col-md-2"> <div class="social-icons d-flex justify-content-around justify-content-md-end"> <a href="/" title="Return to Homepage" class="mx-2">/</a> <a href="http://twitter.com/tarellel" title="Follow me on Twitter" class="mx-2" rel="me"> <em class="fab fa-twitter"></em> </a> <a href="http://github.com/tarellel" title="View my code on GitHub" class="mx-2" rel="me"> <em class="fab fa-github"></em> </a> <a href="mailto:&#116;&#097;&#114;&#101;&#108;&#108;&#101;&#108;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;" title="Email Me" class="mx-2" rel="email"> <em class="fa fa-envelope"></em> </a> </div> <div class="text-right navlinks d-flex justify-content-around flex-md-column p-0 my-2"> <a href="/about" class="nav-items my-sm-3 my-md-0">About</a> <a href="/archive" class="nav-items my-sm-3 my-md-0">Archive</a> </div> </div> <div class="col-md-10 px-3"> <h1 class="post-title">Using UUIDs in Rails</h1> <div class="row"> <div class="d-flex align-self-center w-100 px-3 py-0 mb-xs-3"> <p class="meta w-50 my-1">Jun 12, 2015</p> <div class="w-50 text-right"> Tags: <a href="/tag/database/" rel="tag">database</a>, <a href="/tag/development/" rel="tag">development</a>, <a href="/tag/rails/" rel="tag">rails</a>, <a href="/tag/ruby/" rel="tag">ruby</a> </div> </div> </div> <div class="post"> <h3 id="why-use-uuids">Why use UUIDs?</h3> <p>It may seem like a trivial decision at first glance, but using UUIDs can have an intricate effect on your applications design structure. If you are building an application and have an <code class="highlighter-rouge">id:integer</code> column that auto increments with the creation of every item you add to that table you could end up with some sever issues. As applications grow in size we end up having to seperate parts of the application into different servers: a cluster of database servers, background, jobs, cache server, an httpd server, and throw in a few servers for actual application and you’ve got a whole cluster of services to deal with.</p> <p>Lets say you’ve got 3 servers running the actual application, each one chugging along running serveral instances of your web application. Now say it’s a basic CRUD application if you’ve got several instances writing to the database at once you will have a conflict. If you’ve got a table named books and a few rows are being added at once by seperate visitors, you’re auto incrimenting the rows and lets say on each one it creates row id: 72. Now when they combine their information together you’re going to have an issue with inconsistent data trying to overlap.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Raven</span>
<span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">My</span> <span class="no">Side</span> <span class="n">of</span> <span class="n">the</span> <span class="no">Mountain</span>
<span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Giver</span>
</code></pre></div></div> <p>Now if we were inserting these datasets into the different database servers while using UUIDs we may could up with something to the following example below.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">id: </span><span class="mi">898</span><span class="n">f73bc</span><span class="o">-</span><span class="mi">290</span><span class="n">c</span><span class="o">-</span><span class="mi">4427</span><span class="o">-</span><span class="n">b75a</span><span class="o">-</span><span class="mi">68</span><span class="n">f34464e188</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Raven</span>
<span class="ss">id: </span><span class="n">dd126f47</span><span class="o">-</span><span class="n">de45</span><span class="o">-</span><span class="mi">4</span><span class="n">cbe</span><span class="o">-</span><span class="n">aa1c</span><span class="o">-</span><span class="mi">8</span><span class="n">b052693498e</span><span class="p">,</span> <span class="ss">title: </span><span class="no">My</span> <span class="no">Side</span> <span class="n">of</span> <span class="n">the</span> <span class="no">Mountain</span>
<span class="ss">id: </span><span class="mi">479</span><span class="n">af9a8</span><span class="o">-</span><span class="n">c096</span><span class="o">-</span><span class="mi">42</span><span class="n">e2</span><span class="o">-</span><span class="mi">8</span><span class="n">a29</span><span class="o">-</span><span class="mi">4</span><span class="n">a321cdd5f7c</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Giver</span>
</code></pre></div></div> <p>UUIDs are simple 128-bit generated values and only consisting of formated using hexadecimal text. Depending on <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Variants_and_versions">how they’re being generated</a> their values are generally a random value that will rarely have a collision value. It’s generally safe to say that you can use a distributed application and have several servers generating rows of data and almost never have the same UUID generated (I’m not saying it can’t happen, it’s just a lot less likely to happen).</p> <h3 id="how-can-i-do-this-is-rails">How can I do this is Rails?</h3> <p>When you are generating models and scaffolds the <code class="highlighter-rouge">id</code> column is usually automatically generated with every table (unless specified), this is a feature build into Rails to make it easier and faster to develop.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="s2">"books"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"title"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="k">end</span>

<span class="c1"># Generates</span>
<span class="nb">id</span><span class="ss">:integer</span><span class="p">,</span> <span class="no">PRIMARY</span> <span class="no">KEY</span><span class="p">,</span> <span class="n">auto_increment</span>
<span class="n">title</span><span class="ss">:string</span>
<span class="n">created_at</span><span class="ss">:datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="n">updated_at</span><span class="ss">:datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
</code></pre></div></div> <p>Now depending on what database you are using to test, develop, and deploy you application there are different steps that are required in order to get your application to properly recognize and use the UUID datatype. I have seperated into different sections how I got UUIDs to work in both Postgresql and the SQLite databases.</p> <h3 id="postgresql">Postgresql</h3> <p>The method in order to get uuids to work with Postgres tends to be quite a bit easier (in my opinion), because Postgres has a built in method for generating unique uuids for row ids.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g migration enable_uuid_extension
</code></pre></div></div> <p>In the migration we tell the Postgres database to use the uuid extension, we do this in order to have the database automatically generate UUIDs on the objects creation rather than having the Rails Application generate the UUIDs and adding additional process time to the server.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EnableUuidExtension</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span>
    <span class="n">enable_extension</span> <span class="s1">'uuid-ossp'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now lets generate a book model and get started on adjusting the migration to allow the application to generate a UUID for the id instead of a basic integer.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="no">Book</span> <span class="n">title</span><span class="ss">:string</span>
</code></pre></div></div> <p>Now we also need to change id: to use the :uuid datatype instead of letting the application automatically assigning it.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">id: :uuid</span>  <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now access the rails console <code class="highlighter-rouge">rails c</code> in order to verifiy that UUIDs are being generated upon the models object creation. At this point in time the default version of UUID generation used by Rails is <code class="highlighter-rouge">uuid_generate_v4()</code> which seems to be quite sufficient to avoiding collisions.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mf">2.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'The Raven'</span><span class="p">)</span>
<span class="p">(</span><span class="mf">0.4</span><span class="n">ms</span><span class="p">)</span>  <span class="k">BEGIN</span>
  <span class="no">SQL</span> <span class="p">(</span><span class="mf">35.2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">"books"</span> <span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">,</span> <span class="vg">$3</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">"id"</span>  <span class="p">[[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"The Raven"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:31:03.762157"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"updated_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:31:03.762157"</span><span class="p">]]</span>
   <span class="p">(</span><span class="mf">197.1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">COMMIT</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Book id: "f55ea573-1eec-4053-b7f5-7b693b344da9", title: "The Raven", created_at: "2015-06-13 05:31:03", updated_at: "2015-06-13 05:31:03"&gt;</span>
</code></pre></div></div> <p>If you look closely you will notice that the Book.id is no longer being generated a basic integer, it is not being generating a Hex based text string. As show above: <code class="highlighter-rouge">Book[id]: f55ea573-1eec-4053-b7f5-7b693b344da9</code></p> <h3 id="sqlite">SQLite</h3> <p>To begin using UUIDs with sqlite you will need to install the <a href="https://github.com/jashmenn/activeuuid"><code class="highlighter-rouge">activeuuid</code></a> gem, when using this gem it will save the uuid: as a binary(16) datatype. I haven’t dug around to much into the gem, but it does seem to work quite effectively for it’s purpose.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'activeuuid'</span>  <span class="c1"># https://github.com/jashmenn/activeuuid</span>
</code></pre></div></div> <p>We will now need to adjust the migration to explicity use the uuid: datatype for :id and completely disregard using the default :id dataset and configuration.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># migrations</span>
<span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">uuid</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:primary_key</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>You will also need to include <code class="highlighter-rouge">ActiveUUID::UUID</code> in your model to enable UUID generation, you will need to specify a <code class="highlighter-rouge">natural_key</code> to supply a dataset in order to generate a UUID. If this step is not included the application will throw a heap of errors about the books.id using an invalid uuid datatype.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">ActiveUUID</span><span class="o">::</span><span class="no">UUID</span>
  <span class="n">natural_key</span> <span class="ss">:created_at</span>
<span class="k">end</span>
</code></pre></div></div> <p>Upon creating a book object, you should recieve output with something similar to the example shown below.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mf">2.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'The Raven'</span><span class="p">)</span>
   <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">begin</span> <span class="n">transaction</span>
  <span class="no">SQL</span> <span class="p">(</span><span class="mf">0.5</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">"books"</span> <span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="sc">?,</span> <span class="p">?,</span> <span class="sc">?,</span> <span class="p">?)</span>  <span class="p">[[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"&lt;16 bytes of binary data&gt;"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"The Raven"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:57:45.728134"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"updated_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:57:45.728134"</span><span class="p">]]</span>
   <span class="p">(</span><span class="mf">3.4</span><span class="n">ms</span><span class="p">)</span>  <span class="n">commit</span> <span class="n">transaction</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Book id: #&lt;UUID:0x3feef3549684 UUID:a5093dd9-cb33-5783-b01c-0d0d381490f1&gt;, title: "The Raven", created_at: "2015-06-13 05:57:45", updated_at: "2015-06-13 05:57:45"&gt;</span>
</code></pre></div></div> <h4 id="resources">Resources</h4> <ul> <li><a href="https://github.com/jashmenn/activeuuid">activeuuid</a></li> <li><a href="http://www.postgresql.org/docs/9.3/static/datatype-uuid.html">PostgreSQL UUID type</a></li> <li><a href="http://www.postgresql.org/docs/9.3/static/uuid-ossp.html">PostgreSQL uuid-ossp extensions</a></li> </ul> </div> <div class="ads"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-0584655001678892",enable_page_level_ads:!0});</script> </div> <div id="disqus_thread"></div> <script>!function(){var e=document,t=e.createElement("script");t.src="//theworkaround.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> <script>!function(e,a,n,t,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(n),s=a.getElementsByTagName(n)[0],o.async=1,o.src=t,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-41384218-1","theworkaround.com"),ga("send","pageview");</script> </body> </html>