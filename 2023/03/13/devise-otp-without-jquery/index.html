<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="Content-Language" content="en"> <title>Devise-OTP without jQuery | TheWorkAround</title> <meta property="og:title" content="Devise-OTP without jQuery"/> <meta name="author" content="Brandon"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="Generate devise OTP (2fa) without needing jQuery for the QRcode generation"/> <meta property="og:description" content="Generate devise OTP (2fa) without needing jQuery for the QRcode generation"/> <link rel="canonical" href="https://theworkaround.com/2023/03/13/devise-otp-without-jquery/"/> <meta property="og:url" content="https://theworkaround.com/2023/03/13/devise-otp-without-jquery/"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2023-03-13T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Devise-OTP without jQuery"/> <link type="application/atom+xml" rel="alternate" href="https://theworkaround.com/feed.xml" title="TheWorkAround"/> <meta name="author" content="Brandon Hicks"> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta name="generator" content="Bridgetown"> <meta name="referrer" content="no-referrer-when-downgrade"> <meta name="robots" content="index, follow"> <link rel="preload" href="/_bridgetown/static/index.AIKPFYK3.css" as="style"> <link rel="preload" href="/_bridgetown/static/index.IGRG3H33.js" as="script"> <link rel="preconnect" href="/" crossorigin> <link rel="preconnect" href="https://rsms.me/inter/inter.css" crossorigin> <link rel="dns-prefetch" href="https://www.googletagmanager.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link rel="stylesheet" href="/_bridgetown/static/index.AIKPFYK3.css" data-turbo-track="reload"/> <script src="/_bridgetown/static/index.IGRG3H33.js" data-turbo-track="reload" defer></script> <link href="https://theworkaround.com/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="https://theworkaround.com/humans.txt" rel="author" type="text/plain"> <link rel="manifest" href="https://theworkaround.com/site.webmanifest"> <link rel="me" href="https://theworkaround.com/" type="text/html"> <link rel="me" href="https://github.com/tarellel"> <link rel="me" href="https://twitter.com/tarellel"> <meta name="theme-color" content="#4cb8c4"> </head> <body class="post antialiased min-h-full font-inter font-normal leading-normal bg-white text-gray-400"> <nav class="border-t-12 border-cyan-600 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4" role="navigation" aria-label="Main"> <div class="text-left"> <h3 class="text-3xl font-extrabold text-gray-600"> <a href="/" class="text-gray-600" title="Goto /" key="home">TheWorkAround</a> </h3> <p class="text-md font-semibold leading-5 text-gray-400">Brandon Hicks</p> </div> <div class="sm:text-right text-lg lg:text-xl flex space-y-4 sm:space-y-0 sm:space-x-9 content-center mt-3 sm:mt-0 flex-col sm:flex-row"> <a href="https://theworkaround.com/about" class="font-semibold text-gray-700 tracking-tight" title="About Me" key="about">About</a> <a href="https://theworkaround.com/posts" class="font-semibold text-gray-700 tracking-tight" title="View a list of all posts" key="posts">Posts</a> <a href="https://theworkaround.com/projects"" class="font-semibold text-gray-700 tracking-tight" title="Projects I'm working on" key="projects">Projects</a> <a href="https://theworkaround.com/feed.xml" class="flex content-center text-orange-600" title="RSS Feed" key="feed"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="h-5 w-5 self-center text-orange-600" class=" h-5 w-5 self-center text-orange-600" alt="RSS Feed Icon" aria-hidden="true" focusable="false" role="img"> <path d="M4 11a9 9 0 0 1 9 9"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <circle cx="5" cy="19" r="1"></circle> </svg> </a> </div> </nav> <main class="post px-10 sm:px-7 border-0"> <h1>Devise-OTP without jQuery</h1> <p>Ruby/Rails boasts a unique diversity of available libraries and gems, including several options for authentication such as <a href="https://github.com/heartcombo/devise">Devise</a>, <a href="https://github.com/omniauth/omniauth">omniauth</a>, <a href="https://github.com/thoughtbot/clearance">clearance</a>, <a href="https://github.com/sorcery/sorcery">sorcery</a>, <a href="https://github.com/jeremyevans/rodauth">rodauth</a>, among others. While there are many options to choose from, I personally prefers Devise for its modularity and ease of use.</p> <p>However, any modern application needs more than just an authentication system; you also want to ensure you build on permissions permissions <em>(for authorization)</em>, 2FA, and a solid hash library for additional secure measures.</p> <p>There are several <a href="https://en.wikipedia.org/wiki/Multi-factor_authentication">2fa</a> libraries that you can integrate with Devise, such as <a href="https://github.com/tinfoil/devise-two-factor">devise-two-factor</a>, <a href="https://github.com/wmlele/devise-otp">devise-otp</a>, <a href="https://github.com/williamatodd/devise-2fahttps://github.com/williamatodd/devise-2fa">devise-2fa</a>, <a href="https://github.com/Houdini/two_factor_authentication">two_factor_authentication</a>, among others. I honestly prefer <a href="https://github.com/wmlele/devise-otp">Devise-OTP</a> for its ease of use and adherence to <a href="https://datatracker.ietf.org/doc/html/rfc6238">RFC 6238</a> implementation using the <a href="https://github.com/mdp/rotp">ROTP</a> gem.</p> <p>However I did encounter an issue with Devise-OTP in that it still assumes applications using it are using Sprockets and jQuery, and the <a href="https://github.com/wmlele/devise-otp/blob/master/app/assets/javascripts/qrcode.js">qrcode JS</a> file it includes requires jQuery. While I still use jQuery regularly at work, I have moved to using StimulusJS for personal projects.</p> <p>After attempting to use several npm packages <em>(like <a href="https://github.com/soldair/node-qrcode">node-qrcode</a>)</em> for generating the users 2fa QRcodes, I also found that 1Password had issues when scanning for a valid 2FA QR code; which could be a significant concern for many users. It is noted that the gem has a handy <a href="https://github.com/wmlele/devise-otp/blob/master/lib/devise_otp_authenticatable/controllers/helpers.rb#L148">helper</a> <code class="highlighter-rouge">otp_authenticator_token_image_google</code> for generating QR codes using the Google Chart API, but generating QR codes with a third party like Google may not be the most security-conscious decision.</p> <p><img src="/images/posts/devise_otp_without_query/qrcode.png" alt="qrcode" class="img-fluid w-3/12"/></p> <p>After some playing around I was able to find an alternative method to get the qrcodes genreted in the application and without requiring jQuery to be included.</p> <p>First to modify devise-opts views I ran the generator so they would be in the app, rather than in the gem.</p> <p><code class="highlighter-rouge">rails g devise_otp:views</code></p> <p>Next I added the follow gems to my Gemfile and bundled</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'rotp'</span>
<span class="n">gem</span> <span class="s1">'rqrcode'</span>
</code></pre></div></div> <p>In my users helper I added the following method to generate the users 2fa QRcode</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">otp_rqr_image</span><span class="p">(</span><span class="n">otp_url</span><span class="p">)</span>
  <span class="n">qr_code</span> <span class="o">=</span> <span class="no">RQRCode</span><span class="o">::</span><span class="no">QRCode</span>
            <span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">otp_url</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">as_png</span><span class="p">(</span><span class="ss">resize_exactly_to: </span><span class="mi">300</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">to_data_url</span>
  <span class="n">image_tag</span><span class="p">(</span><span class="n">qr_code</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now within the view files that the gem generated you should have <code class="highlighter-rouge">app/views/devise/otp_tokens/_token_secret.html.slim</code>. This <a href="https://github.com/wmlele/devise-otp/blob/master/app/views/devise/otp_tokens/_token_secret.html.erb#L4">file</a> is where the qrcode is generate for the user. I replaced the <code class="highlighter-rouge">otp_authenticator_token_image</code> (jQuery based) method with the <code class="highlighter-rouge">otp_rqr_image</code> that we created earlier. You should now have a valid 2fa QRcode which is also scanable by 1Password and most of password managers or 2fa authenticators.</p> <p><img src="/images/posts/devise_otp_without_query/2fa_user_qrcode.png" alt="qrcode" class="img-fluid w-4/5"/></p> </main> <footer class="space-y-3 text-sm text-center"> <p> Contact me at <a href="mailto:tarellel@gmail.com">tarellel@gmail.com</a> <p/> <p> &copy; 2004 - 2023 Brandon Hicks - All rights reserved.<br> Content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons 4.0 License</a>.<br> Code samples and snippets are licensed under the <a href="https://github.com/tarellel/theworkaround.com/blob/main/LICENSE">MIT License</a> </p> </footer> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41384218-1"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-41384218-1');
    </script> </body> </html>