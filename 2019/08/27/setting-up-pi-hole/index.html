<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="Content-Language" content="en"> <title>Setting up a Pi-Hole | TheWorkAround</title> <meta property="og:title" content="Setting up a Pi-Hole"/> <meta name="author" content="Brandon"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta property="og:description" content="The infinite ramblings and ideas of Brandon Hicks"/> <link rel="canonical" href="https://theworkaround.com/2019/08/27/setting-up-pi-hole/"/> <meta property="og:url" content="https://theworkaround.com/2019/08/27/setting-up-pi-hole/"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-08-27T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Setting up a Pi-Hole"/> <link type="application/atom+xml" rel="alternate" href="https://theworkaround.com/feed.xml" title="TheWorkAround"/> <meta name="author" content="Brandon Hicks"> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta name="generator" content="Bridgetown"> <meta name="referrer" content="no-referrer-when-downgrade"> <meta name="robots" content="index, follow"> <link rel="preload" href="/_bridgetown/static/index.PLTX3XEL.css" as="style"> <link rel="preload" href="/_bridgetown/static/index.KL3TZR4T.js" as="script"> <link rel="preconnect" href="/" crossorigin> <link rel="preconnect" href="https://rsms.me/inter/inter.css" crossorigin> <link rel="dns-prefetch" href="https://www.googletagmanager.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link rel="stylesheet" href="/_bridgetown/static/index.PLTX3XEL.css" data-turbo-track="reload"/> <script src="/_bridgetown/static/index.KL3TZR4T.js" data-turbo-track="reload" defer></script> <link href="https://theworkaround.com/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="https://theworkaround.com/humans.txt" rel="author" type="text/plain"> <link rel="manifest" href="https://theworkaround.com/site.webmanifest"> <link rel="me" href="https://theworkaround.com/" type="text/html"> <link rel="me" href="https://github.com/tarellel"> <link rel="me" href="https://twitter.com/tarellel"> <meta name="theme-color" content="#4cb8c4"> </head> <body class="post antialiased min-h-full font-inter font-normal leading-normal bg-white text-gray-400"> <nav class="border-t-12 border-cyan-600 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4" role="navigation" aria-label="Main"> <div class="text-left"> <h3 class="text-3xl font-extrabold text-gray-600"> <a href="/" class="text-gray-600" title="Goto /" key="home">TheWorkAround</a> </h3> <p class="text-md font-semibold leading-5 text-gray-400">Brandon Hicks</p> </div> <div class="sm:text-right text-lg lg:text-xl flex space-y-4 sm:space-y-0 sm:space-x-9 content-center mt-3 sm:mt-0 flex-col sm:flex-row"> <a href="https://theworkaround.com/about" class="font-semibold text-gray-700 tracking-tight" title="About Me" key="about">About</a> <a href="https://theworkaround.com/posts" class="font-semibold text-gray-700 tracking-tight" title="View a list of all posts" key="posts">Posts</a> <a href="https://theworkaround.com/projects"" class="font-semibold text-gray-700 tracking-tight" title="Projects I'm working on" key="projects">Projects</a> <a href="https://theworkaround.com/feed.xml" class="flex content-center text-orange-600" title="RSS Feed" key="feed"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="h-5 w-5 self-center text-orange-600" class=" h-5 w-5 self-center text-orange-600" alt="RSS Feed Icon" aria-hidden="true" focusable="false" role="img"> <path d="M4 11a9 9 0 0 1 9 9"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <circle cx="5" cy="19" r="1"></circle> </svg> </a> </div> </nav> <main class="post px-10 sm:px-7 border-0"> <h1>Setting up a Pi-Hole</h1> <p>Before we get started, if you haven’t heard of the <a href="https://pi-hole.net/">PiHole</a> module. It’s an Open Source networking product that’s <a href="https://www.reddit.com/r/pihole/">exploding</a> in the consumer networking world. Let me begin by saying at my families house we have multiple TV’s (a smart TV and a TV with a Roku), the kids each have tablets, and my wife and I have our phones and laptops, as well as a few personal servers (local NAS and development servers). And for the majority of the time, most of these devices are sending and receiving traffic at any given time.</p> <p>For several months in a row our households bandwidth peaked over our xfinity (<em>Comcast</em>) data cap. I mean $10/$20 extra every month doesn’t sound like much, but it adds up (especially when you have kids). So I started to monitoring our networks traffic a little more thoroughly, and it turns out a pretty sizeable amount of our throughput was from advertisements. I’m not going to deny watching Netflix, Hulu, Disney+, and YouTube doesn’t consume a ton of bandwidth; but our network was congested with a ton of traffic, that honestly we had no idea was even being used.</p> <p>Let me say since I setup our PiHole our network speed seems to have dramatically increased and as you can see from the picture below our network traffic have halved. I’m only theorizing here, but the increase in network speed seems to be from from a combination of having a local DNS within our home network, as well as denying network traffic to a <em><strong>TON</strong></em> of external resources.</p> <p><img src="/images/posts/setting_up_a_pihole/network_traffic.png" alt="" class="img-fluid w-3/12 sm-w-100"/></p> <p>I won’t be walking you through how to setup the RasberryPi with Rasbian, but if you haven’t set it up yet I would suggest starting with their <a href="https://www.raspberrypi.org/documentation/raspbian/">documentation</a>. (I setup my Pi using <a href="https://www.raspberrypi.org/downloads/raspbian/">Rasbian Lite</a> to reduce the number of wasted resources, since it will be mainly used as a headless network device.)</p> <p>My PiHole setup consists of a <a href="https://www.amazon.com/gp/product/B07TZNW8X2/">Raspberry Pi 4</a> with 4GB of RAM and because of the <a href="https://www.jeffgeerling.com/blog/2019/raspberry-pi-4-needs-fan-heres-why-and-how-you-can-add-one">heat issue</a> that everyone’s complaining about; I also purchased a <a href="https://www.amazon.com/gp/product/B07TXSQ47L">case with a cooling fan</a>. I know, 4GB is way overboard for a for such a <a href="https://pi-hole.net/2017/05/24/how-much-traffic-can-pi-hole-handle/">lightweight process</a> and used as a local DNS server, but I’m also using it for a number of other services as well.</p> <h3 id="begin-setup">Begin setup</h3> <p>This first step isn’t required, but I ran the following command (<code class="highlighter-rouge">lsb_release -a &amp;&amp; uname -a</code>) so you could see what Rasbian release this setup was build on.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>No LSB modules are available.
Distributor ID: Raspbian
Description:  Raspbian GNU/Linux 10 <span class="o">(</span>buster<span class="o">)</span>
Release:  10
Codename: buster
Linux Falion 4.19.58-v7l+ <span class="c">#1245 SMP Fri Jul 12 17:31:45 BST 2019 armv7l GNU/Linux</span>
</code></pre></div></div> <h3 id="adjust-rasbian-configuaton">Adjust Rasbian Configuaton</h3> <p>Next you’ll need to run <code class="highlighter-rouge">sudo raspi-config</code> and update the configurations listed below.</p> <ul> <li>Setup new password</li> <li>Set Hostname</li> <li>Set locales (en_us.utf-8, timezone, keyboard layout, country)</li> <li>Update raspi-cofig tool</li> </ul> <p>After these changes, lets restart the Pi so the new configuration changes will be applied <code class="highlighter-rouge">shutdow now -r</code></p> <p>Since this will be an important component in your network, lets start out on the right foot and remember that we need to be thinking about security with every step along the way. Once your Pi has finished restarting, you’ll need to change the root password.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su <span class="c"># This is used to switch to the root user</span>
passwd  <span class="c"># Used to change the current users password</span>
</code></pre></div></div> <p>Next, lets update all currently installed packages and ensure security when installing optional packages.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Update all software on the Pi</span>
apt-get update <span class="o">&amp;&amp;</span> apt-get upgrade <span class="nt">-y</span> <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>apt-transport-https ca-certificates <span class="nt">-y</span>
</code></pre></div></div> <h3 id="hardening-the-pi">Hardening the Pi</h3> <p>I’m not going to cover every single step of hardening you’re RaspberryPi, but if you need an even deeper understanding of Linux security there are an endless supply of guides on how to harden a Debian based distro.</p> <p>Lets start by create an additional user, and removing the default <code class="highlighter-rouge">pi</code> user. This is more of a <a href="https://en.wikipedia.org/wiki/Security_through_obscurity">security by obscurity</a>, because everyone will knows that by default your devices will have a user named <code class="highlighter-rouge">pi</code> which gets them one step closer to having access to your device.</p> <p>First we need to create the new user <code class="highlighter-rouge">sudo adduser user_name</code></p> <p>Now lets add the new user to the list of sudoers</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/sudoers.d/010_pi-nopasswd
<span class="c"># This allows the new user to run sudo, but requires a valid password to entered first</span>
user_name <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> PASSWD: ALL

<span class="c"># You can also run the following</span>
<span class="nb">sudo</span> /usr/sbin/useradd <span class="nt">--groups</span> <span class="nb">sudo</span> <span class="nt">-m</span> user_name
</code></pre></div></div> <p>You’ll now need to be sure to completely kill the current terminal session as the <code class="highlighter-rouge">pi</code> user, I’d suggest typing <code class="highlighter-rouge">logout</code> to make sure the session is properly killed.</p> <p>The next step is to login as the user we just created, remove the default <code class="highlighter-rouge">pi</code> user that, and then remove this user from the list of sudoers. (This may seem like a bunch of unnecessary steps, but we want to ensure at least a minimum level of security.)</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># now ssh into the pi using the new user</span>
ssh user_name@192.168.1.5
<span class="nb">sudo </span>su

<span class="c"># Remove the pi user</span>
<span class="nb">sudo </span>deluser <span class="nt">-remove-home</span> pi

<span class="c"># Remove the user from the sudoer list as well</span>
<span class="nb">sudo </span>nano /etc/sudoers.d/010_pi-nopasswd
-&gt; pi <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD: ALL
</code></pre></div></div> <h4 id="lets-start-with-ssh">Let’s start with SSH</h4> <p>Now since I’m running this as a headless device on my network I’ll only be accessing this device through a shell terminal. So the next step is to begin by locking down OpenSSH. I know this complicates things to another level, but in my setup I generally prefer to to have a different SSH key a number of services. I use one key for my DigitalOcean servers, one key for Github, another key for my works Gitlab account, etc etc. The biggest issue with this is managing a growing number of keys, but if you keep up with configuring your <a href="https://linuxize.com/post/using-the-ssh-config-file/">SSH config</a> file <code class="highlighter-rouge">~/.ssh/config</code> as you generate the keys your maintenance should be pretty minimal. My rational behind this is; some people use a single key for every service which is logical, I mean it’s <a href="https://security.stackexchange.com/questions/112718/difficulty-of-breaking-private-key-password">not exactly</a> easy to crack a 4096 encryption key. But if you somehow happen to leak that one private key, any and all services you have associate with it are now compromised. If you have a different RSA key for each major service you use and one key gets comprised the impact should minimal rather than effecting a large number of services.</p> <p>Now it may be a personal preference but rather than just generating a generic RSA key I prefer to use <a href="https://ed25519.cr.yp.to">ed25519 keys</a>, mainly because they’re small, fast, and very secure. (If you need instructions on how to <a href="https://theworkaround.com/2016/11/11/enhancing-ssh-security.html#newer-key-types">generate ed25519 keys</a>, I have a snip on one of my previous posts.)</p> <p>Now we need to ensure we have the latest version of OpenSSH installed, to do this run the following command: <code class="highlighter-rouge">sudo apt install openssh-server</code></p> <p>The configuration I use follows pretty closely to a combination of the <a href="https://infosec.mozilla.org/guidelines/openssh">Mozilla SSH Guidelines (Modern)</a> and <a href="http://tldp.org/LDP/solrhe/Securing-Optimizing-Linux-RH-Edition-v1.3/chap15sec122.html"><abbr title="The Linux Documentation Project">TLDP</abbr></a> recommendations.</p> <p>Lets open our ssh_config file and replace the configuration with the snippet posted below - <code class="highlighter-rouge">sudo nano /etc/ssh/sshd_config</code></p> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Adapted from the "Modern" configuration detailed on the Mozilla Security
# Guidelines wiki (https://wiki.mozilla.org/Security/Guidelines/OpenSSH).
# https://github.com/mozilla/socorro-infra/blob/master/puppet/modules/socorro/files/etc_ssh/sshd_config
# http://tldp.org/LDP/solrhe/Securing-Optimizing-Linux-RH-Edition-v1.3/chap15sec122.html
# docs: http://tldp.org/LDP/solrhe/Securing-Optimizing-Linux-RH-Edition-v1.3/chap15sec122.html
# Package generated configuration file
# See the sshd_config(5) manpage for details
</span>
<span class="err">Port</span> <span class="err">22</span>
<span class="err">Protocol</span> <span class="err">2</span>
<span class="err">HostKey</span> <span class="err">/etc/ssh/ssh_host_ed25519_key</span>
<span class="err">HostKey</span> <span class="err">/etc/ssh/ssh_host_rsa_key</span>
<span class="err">HostKey</span> <span class="err">/etc/ssh/ssh_host_ecdsa_key</span>

<span class="err">KexAlgorithms</span> <span class="err">curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256</span>
<span class="err">Ciphers</span> <span class="err">chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr</span>
<span class="err">MACs</span> <span class="err">hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com</span>

<span class="c"># Completely disable password based logins, PublicKey login is required
</span><span class="err">PubkeyAuthentication</span> <span class="err">yes</span>
<span class="c">#AuthenticationMethods publickey,keyboard-interactive:pam # enables multiset authentication PublicKey-&gt;Password
</span><span class="err">AuthenticationMethods</span> <span class="err">publickey</span>
<span class="err">KbdInteractiveAuthentication</span> <span class="err">yes</span>

<span class="c"># Lifetime and size of ephemeral version 1 server key
</span><span class="err">KeyRegenerationInterval</span> <span class="err">3600</span> <span class="c"># to prevent descryption, regenerate connection keys
</span><span class="err">ServerKeyBits</span> <span class="err">1024</span>

<span class="c"># Limit to users/groups
</span><span class="err">AllowUsers</span> <span class="err">tarellel</span>

<span class="c"># Don't read the user's ~/.rhosts and ~/.shosts files
</span><span class="err">IgnoreRhosts</span> <span class="err">yes</span>  <span class="c"># prevents login from trusted networks
#RhostsAuthentication no
</span><span class="err">RhostsRSAAuthentication</span> <span class="err">no</span>

<span class="c"># Logging
#SyslogFacility AUTH
</span><span class="err">SyslogFacility</span> <span class="err">AUTHPRIV</span>
<span class="err">LogLevel</span> <span class="err">INFO</span>

<span class="c"># Log sftp level file access (read/write/etc.) that would not be easily logged otherwise.
</span><span class="err">Subsystem</span> <span class="err">sftp</span>  <span class="err">/usr/lib/openssh/sftp-server</span> <span class="err">-f</span> <span class="err">AUTHPRIV</span> <span class="err">-l</span> <span class="err">INFO</span>

<span class="c"># Authentication:
</span><span class="err">PermitRootLogin</span> <span class="err">No</span>
<span class="err">UsePrivilegeSeparation</span> <span class="err">sandbox</span> <span class="c"># prevent user privilege escalation
</span><span class="err">LoginGraceTime</span> <span class="err">30</span> <span class="c"># default 120/2m
</span><span class="err">StrictModes</span> <span class="err">yes</span> <span class="c"># checks user [~] permissions
</span>
<span class="err">X11Forwarding</span> <span class="err">no</span> <span class="c"># may wish to turn this off for security purposes it was defaulted to yes
</span><span class="err">AllowTcpForwarding</span> <span class="err">no</span>
<span class="c"># ClientAliveCountMax 2 # max amount of concurrently connected clients
# http://serverfault.com/questions/275669/ssh-sshd-how-do-i-set-max-login-attempts
# MaxAuthTries 1 # 1 login attempt per connection, before being dropped
# MaxSessions Specifies the maximum number of open sessions permitted per network connection
# MaxSessions 2
</span>
<span class="c"># https://patrickmn.com/aside/how-to-keep-alive-ssh-sessions/
# Keep idle TCP connections alive (kill idle connections)
</span><span class="err">TCPKeepAlive</span> <span class="err">no</span>
<span class="err">ClientAliveInterval</span> <span class="err">120</span> <span class="c"># how long the connection can be idle (seconds)
</span>
<span class="c"># NOTE: It's best to disable this when forwarding is also disabled
</span><span class="err">Compression</span> <span class="err">no</span>

<span class="err">PasswordAuthentication</span> <span class="err">no</span>
<span class="err">PermitEmptyPasswords</span> <span class="err">no</span>
<span class="err">ChallengeResponseAuthentication</span> <span class="err">yes</span>

<span class="c"># Login/Logout messages
</span><span class="err">PrintMotd</span> <span class="err">no</span>
<span class="c"># Banner /etc/issue.net
</span>
<span class="err">UsePAM</span> <span class="err">yes</span>
<span class="c"># Ensure /bin/login is not used so that it cannot bypass PAM settings for sshd.
</span><span class="err">UseLogin</span> <span class="err">no</span>
<span class="err">UseDNS</span> <span class="err">no</span>
</code></pre></div></div> <p>Next you’ll need to ensure your personal machines public ssh-key is on the Raspberry, so you won’t be locked out of the device. On your local machine run <code class="highlighter-rouge">pbcopy &lt; ~/.ssh/.ssh/localnetwork_id.pub</code> this copys the contents of your SSH’s publickey to your clip. (As I mentioned before, I prefer to generate SSH keys for different services. The SSH-key <code class="highlighter-rouge">localnetwork</code> was generated for all devices in my local home network).</p> <p>Now go back to the terminal and ensure the authorized_keys file creates for the current user in the ssh folder <code class="highlighter-rouge">mkdir ~/.ssh; chmod 0700 ~/.ssh; touch ~/.ssh/authorized_keys; nano ~/.ssh/authorized_keys</code>. The last part of this command opens up the <code class="highlighter-rouge">authorized_keys</code> file in nano, since you previously copied the contents of you public key to your clipboard lets go ahead paste into the this file and hit CTRL-X and save the file. After the contents have been saved you’ll need to chmod it to ensure access to it’s contents is limited <code class="highlighter-rouge">chmod 0600 ~/.ssh/authorized_keys</code>. In order for all these changes to be applied you’ll need to restart the ssh process <code class="highlighter-rouge">sudo systemctl restart ssh</code> (you could always do something like <code class="highlighter-rouge">systemctl reload ssh</code> but I prefer to just restart the process).</p> <h4 id="lets-add-a-firewall">Lets add a firewall</h4> <p>I’m sure there will be some moaning that I’m using <a href="https://launchpad.net/ufw">UFW</a> over <a href="https://linux.die.net/man/8/iptables">IPtables</a>, but I find UFW to be easy to get started with and it does exactly what I need.</p> <p>Let’s begin by installing the UFW package <code class="highlighter-rouge">sudo apt-get install ufw</code>. But for me, after intalling UFW I started getting “an IP tables error has occured” when trying to start the UFW server. So again I restarted the Pi and after it had finished reloading all errors were gone. Below are the UFW rules used to begin security incoming network services for your device, before running these commands it helps to <code class="highlighter-rouge">su sudo</code> so you’re creating these rules as a root user.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Some people also prefer to be extra cautious and also begin by blocking all outgoing connects `ufw default deny outgoing` ports.</span>
ufw default deny incoming <span class="c"># Block ALL incoming ports</span>
ufw allow ssh
ufw allow 53    <span class="c"># DNS port</span>
ufw allow http  <span class="c"># Port 80 &amp; 443 are used by PiHole to display a dashboard with PHP/lighttpd</span>
ufw allow https

<span class="c"># Limit the number of login attempts on SSH port</span>
ufw limit ssh/tcp

<span class="c"># Allow FTL pihole engine from LAN (if you are using a different subnet specify this instead)</span>
ufw allow from 192.168.1.0/24 to any port 4711 proto tcp

ufw <span class="nb">enable</span>
</code></pre></div></div> <p>Now that a few basic firewall rules have been creates let’s reload the UFW service in order for these rules to start being applies <code class="highlighter-rouge">sudo ufw reload</code>.</p> <h4 id="fail2ban">Fail2Ban</h4> <p>Next we’ll setup <a href="https://www.fail2ban.org/wiki/index.php/Main_Page">Fail2Ban</a>, which is one of my favorite tools to prevent <a href="https://en.wikipedia.org/wiki/Brute-force_attack">BruteForcing</a> and/or <a href="https://www.owasp.org/index.php/Credential_stuffing">credential stuffing</a> login attempts. With the firewall setup; we’ve already taken the measure of preventing network requests to a large number of ports and services. But whenever there’s an open SSH port, I guarentee you it will get hit with requests. (I averted this by only having a VPN port on my router and in order to access my network from outside the network requires you to conenct via VPN into my network, but I’ll cover that farther down.)</p> <p>Begin by installing the fail2ban package <code class="highlighter-rouge">apt install fail2ban</code>, than we’ll adjust the configuration to begin monitoring any and all ssh login attemps</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
<span class="nb">sudo </span>nano /etc/fail2ban/jail.local
</code></pre></div></div> <p>Once nano has opened up <code class="highlighter-rouge">/etc/fail2ban/jail.local</code> hit Ctrl+W and search for <code class="highlighter-rouge">[sshd]</code> and change the configuration for ssh to the following.</p> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[sshd]</span>
<span class="py">enabled</span>  <span class="p">=</span> <span class="s">true</span>
<span class="py">port</span>     <span class="p">=</span> <span class="s">ssh</span>
<span class="py">filter</span>   <span class="p">=</span> <span class="s">sshd</span>
<span class="py">logpath</span>  <span class="p">=</span> <span class="s">/var/log/auth.log</span>
<span class="py">maxretry</span> <span class="p">=</span> <span class="s">3</span>
<span class="py">bantime</span> <span class="p">=</span> <span class="s">-1</span>
</code></pre></div></div> <p>Now lets restart and enable fail2ban and verify the process and configuration have properly loaded</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service fail2ban restart<span class="p">;</span> service fail2ban start <span class="nb">enable</span>

<span class="c"># Verify fail2ban is running</span>
service fail2ban status
</code></pre></div></div> <p>This step isn’t required, but I like to get the fail2ban client status to ensure the sshd jails (or any others you may add) are enabled <code class="highlighter-rouge">sudo fail2ban-client status</code></p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Status <span class="k">for </span>the jail: sshd
|- Filter
|  |- Currently failed:	0
|  |- Total failed:	0
|  <span class="sb">`</span>- File list:	/var/log/auth.log
<span class="sb">`</span>- Actions
   |- Currently banned:	0
   |- Total banned:	0
   <span class="sb">`</span>- Banned IP list:
</code></pre></div></div> <h4 id="unattended-upgrades">Unattended Upgrades</h4> <p>Another one of my favorite tools on a <a href="https://www.debian.org/">Debian</a> based distro is <a href="https://wiki.debian.org/UnattendedUpgrades">Unattended Upgrades</a>. For those of you who have never used it before, it will systematically apply security updates, distro updates, or whatever kind of upgrades you choose to allow it to update. I prefer to keep everything up to do, but it can be danger to enable allowing automatic updates to something such as a webserver. If this is the case, I’d suggest only enabling security updates; because major package upgrades can and will break your software.</p> <p>Again let’s begin by installing the required packages <code class="highlighter-rouge">sudo apt-get install unattended-upgrades -y</code>. Once the package has installed you’ll need to update it’s default configuration <code class="highlighter-rouge">sudo nano /etc/apt/apt.conf.d/50unattended-upgrades</code> to the following: <em>(The contents of the file specify what updates to look for.)</em></p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Unattended</span><span class="o">-</span><span class="nx">Upgrade</span><span class="p">::</span><span class="nx">Origins</span><span class="o">-</span><span class="nx">Pattern</span> <span class="p">{</span>
  <span class="c1">// Codename based matching:</span>
  <span class="c1">// This will follow the migration of a release through different</span>
  <span class="c1">// archives (e.g. from testing to stable and later oldstable).</span>
  <span class="c1">// Software will be the latest available for the named release,</span>
  <span class="c1">// but the Debian release itself will not be automatically upgraded.</span>
  <span class="dl">"</span><span class="s2">origin=Debian,codename=${distro_codename}-updates</span><span class="dl">"</span><span class="p">;</span>
  <span class="c1">// origin=Debian,codename=${distro_codename}-proposed-updates";</span>
  <span class="dl">"</span><span class="s2">origin=Debian,codename=${distro_codename},label=Debian</span><span class="dl">"</span><span class="p">;</span>
  <span class="dl">"</span><span class="s2">origin=Debian,codename=${distro_codename},label=Debian-Security</span><span class="dl">"</span><span class="p">;</span>
  <span class="c1">// Archive or Suite based matching:</span>
  <span class="c1">// Note that this will silently match a different release after</span>
  <span class="c1">// migration to the specified archive (e.g. testing becomes the</span>
  <span class="c1">// new stable).</span>
  <span class="c1">// "o=Debian,a=stable";</span>
  <span class="c1">// "o=Debian,a=stable-updates";</span>
  <span class="c1">// "o=Debian,a=proposed-updates";</span>
  <span class="c1">// "o=Debian Backports,a=${distro_codename}-backports,l=Debian Backports";</span>
<span class="p">};</span>
</code></pre></div></div> <p>The next step is to open up <code class="highlighter-rouge">/etc/apt/apt.conf.d/20auto-upgrades</code> and configure what components of unattended-upgrades you want to enable. In order to keep my packages up to date with the latest changes I changed mine to the following configuration:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">APT</span><span class="p">::</span><span class="nx">Periodic</span><span class="p">::</span><span class="nx">Update</span><span class="o">-</span><span class="nx">Package</span><span class="o">-</span><span class="nx">Lists</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">;</span>
<span class="nl">APT</span><span class="p">::</span><span class="nx">Periodic</span><span class="p">::</span><span class="nx">Download</span><span class="o">-</span><span class="nx">Upgradeable</span><span class="o">-</span><span class="nb">Packages</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">;</span>
<span class="nl">APT</span><span class="p">::</span><span class="nx">Periodic</span><span class="p">::</span><span class="nx">Unattended</span><span class="o">-</span><span class="nx">Upgrade</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">;</span>
<span class="nl">APT</span><span class="p">::</span><span class="nx">Periodic</span><span class="p">::</span><span class="nx">Verbose</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">;</span>
<span class="nl">APT</span><span class="p">::</span><span class="nx">Periodic</span><span class="p">::</span><span class="nx">AutocleanInterval</span> <span class="dl">"</span><span class="s2">7</span><span class="dl">"</span><span class="p">;</span>
</code></pre></div></div> <p>Now let’s enable unattended upgraded as a low priority process <code class="highlighter-rouge">sudo dpkg-reconfigure --priority=low unattended-upgrades</code> to being monitoring and applying future updates in order to keep our device secure.</p> <h2 id="installing-pihole">Installing PiHole</h2> <p>I know thus far, it’s been like provisioning any other Linux box; but now comes the fun part. To get started quickly run the following command <code class="highlighter-rouge">curl -sSL https://install.pi-hole.net | bash</code>, it does take a few moments because it attempts to install any additional required libraries. It also required to select a number of configurations based on how you like your PiHole setup.</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_1.png" alt="Beginning Install (15%)" class="img-fluid w-50 sm-w-100"/></p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_2.png" alt="PiHole Network Notice" class="img-fluid w-50 sm-w-100"/></p> <p>After going through a few of the setup screens you’ll be presented with your fix big choice. Which DNS Upstream do you with to use? You’ll be presented with a number of choices, including but not limited to Google, OpenDNS, Level3, CloudFlare and a number of other choices. I’m my opinion I suggest picking CloudFlare their <a href="https://www.cloudflare.com/dns/">DNS</a> service is extremely fast and their whole suite of services is about providing security by default.</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_3.png" alt="Selecting Upstream Provider" class="img-fluid w-50 sm-w-100 sm-w-100"/></p> <p>Next you’ll be present with of thirdparty blocklists to choose from, this is completely up to you and what you want to block. And you can always add more later (which we do with this walkthrough).</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_4.png" alt="Choosing your blocklists" class="img-fluid w-50 sm-w-100"/></p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_5.png" alt="Installing additional packages" class="img-fluid w-50 sm-w-100"/></p> <p>Since we setup UFW network requests should be filtered. Part of the installation script ensures that the proper ports available in order for the pihole to function properly.</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_6.png" alt="Opening up the firewall" class="img-fluid w-50 sm-w-100"/></p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_7.png" alt="Terminal display of PiHole Installing" class="img-fluid w-50 sm-w-100"/></p> <p>Once the installation has finished installing you should be presented with a final menu telling you your PiHoles dashboard address and password. (The address should be something like <code class="highlighter-rouge">http://192.168.1.5/admin</code>). When visiting the dashboard you should be presented with something similar to the following image:</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_8.png" alt="PiHole Dashboard" class="img-fluid w-50 sm-w-100"/></p> <p>Now for the most part you’re almost, next we’ll need to configure our router to query the PiHole service for any DNS requests. To do this you’ll need to change your Routers DNS settings to use the internal IP Address for the RaspberryPi. I also applied CloudFlares DNS IP Addresses <code class="highlighter-rouge">1.1.1.1</code> and <code class="highlighter-rouge">1.0.0.1</code>. This is because for any reason the Pi is shutdown or inaccessible your network won’t come a dead halt, it’ll fallback to the secondary DNS server (Cloudflare).</p> <p><img src="/images/posts/setting_up_a_pihole/installing_pihole_9.png" alt="PiHole Dashboard" class="img-fluid w-50 sm-w-100"/></p> <h3 id="setting-up-vpn-access">Setting up VPN Access</h3> <p><a href="http://www.pivpn.io/">PiVPN</a> is an insanely easy to install and the Pi alternative to installing OpenVPN on an ARM chip.</p> <p>To install it lets run the following command <code class="highlighter-rouge">curl -L https://install.pivpn.io | bash</code></p> <p>Again the commandline menu screen will come up and walk you through the various steps to install PiVPN, some of the steps are pretty quick but once you get to where it needs to generate a certificate for your VPN it will take a while. Once OpenVPN started generating a certificate for the VPN I stepped away because for a snack, but it took a good 5 or 10 minutes to generate.</p> <p>Something to note, I ended up having to set the VPN’s DNS settings as the PI’s static IP Address. It may have just been the situation, but when I was VPN’ing in and the DNS was set as the IP address of the router <code class="highlighter-rouge">192.168.1.1</code> it was causing my computer the pull DNS from the actual network I was connected to rather then through the PiHole service. In order to mitigate this I ended up changing the VPNs DNS settings to use it’s own IP address as the DNS server.</p> <p>To do this we’ll need to modify the openvpn config <code class="highlighter-rouge">nano /etc/openvpn/server.conf</code> and change the following <code class="highlighter-rouge">push "dhcp-option DNS 192.168.1.1"</code> to <code class="highlighter-rouge">push "dhcp-option DNS 192.168.71.1"</code> or to whatever you Pi’s ip address is.</p> <p>If you don’t know your current local IP address you can get this by running <code class="highlighter-rouge">ifconfig</code> and getting the ip address listed under the eth0 network adapter.</p> <p>After this step was complete I ended up rebooting the Pi again, so all the new configuration changes and services would be applied.</p> <p>We’re still a ways off from being finished with setting up the VPN, once the Pi has finished rebooting we need to add users to the VPN. This can be done by running the command <code class="highlighter-rouge">pivpn add</code>. You may want to just have a user and make them authenticate with the signed key, I’m a little cautious and decided to have my user <em>(of course me)</em> require to have a password as well as the signed key to authenticate to the VPN. If you end up needing help or finding additional commands for the VPN you can run the command <code class="highlighter-rouge">pivpn help</code>.</p> <p>The next step I did was pull my generated VPN file to my computer so I could add it to my computer and phone. If you do plan on using your phone, for security reasons I suggest having a seperate VPN key for your computer and mobile phone.</p> <p>To pull the openvpn signature file to you computer using scp, you can run a command similar to the following: <em>(Towards the end of this post I’ll explain how to use the on ur phone or macbook)</em></p> <p><code class="highlighter-rouge">scp -i /Users/pi_user/.ssh/localnetwork_id pi_user@192.168.1.17:/home/tarellel/ovpns/tarellelRemote.ovpn .</code></p> <p>The next step is to enable access to the VPN ports, otherwise we’ll still never be able to VPN into the network through the PI. I started by enabling the UDP VPN port <code class="highlighter-rouge">ufw allow 1194/udp</code>, but for some reason I had issues. To get around this I ended up having to remove this rule and just enable access to the 1194 port in general <code class="highlighter-rouge">ufw allow 1194</code>.</p> <p>After opening up the VPN ports I decided to reload it’s configuration, it may be a bit redundent but what’s it going to hurt.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/init.d/openvpn reload
<span class="c"># Just to verify openvpn reloaded properly</span>
<span class="nb">sudo </span>systemctl status openvpn
</code></pre></div></div> <p>Now we need to update openvpn’s network devices priority <code class="highlighter-rouge">sudo nano /etc/pihole/setupVars.conf</code> and add the following <code class="highlighter-rouge">PIHOLE_INTERFACE=tun0</code> below eth0. The pretty much tells openVPN to use <code class="highlighter-rouge">eth0</code> as it’s primary device and <code class="highlighter-rouge">tun0</code> as the pihole virtual network device.</p> <p>Next we’ll need to list the devices in which we want to allow to make DNS requests through the <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> network service. To add the devices lets open it up <code class="highlighter-rouge">nano /etc/dnsmasq.d/01-pihole.conf</code> and add the following list of devices.</p> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">interface</span><span class="p">=</span><span class="s">eth0</span>
<span class="py">interface</span><span class="p">=</span><span class="s">tun0</span>
</code></pre></div></div> <p>Since we’ve just make some more changes to the OpenVPN configuration and firewall lets reset these services <em>(yes again, I know)</em>.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service openvpn reload
service openvpn restart
systemctl <span class="nb">enable </span>ufw
</code></pre></div></div> <h2 id="install-log2ram">Install log2ram</h2> <p>This next step is pretty important, the reason being SD cards aren’t meant to have files written on and removed from at a constant pace, especially when it comes to generating logs. It’s like havine a piece of paper writing on it and than erasing it, over and over again. Eventually that piece of paper will become useless, the same can be said for SD cards. To mitigate this, we end up using <a href="https://github.com/azlux/log2ram">log2ram</a> which will save our logs in memory and once it consumes X amount of memory it’ll save as an actual log file.</p> <p>The following steps are copied directory from the projects documentation.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-Lo</span> log2ram.tar.gz https://github.com/azlux/log2ram/archive/master.tar.gz
<span class="nb">tar </span>xf log2ram.tar.gz
<span class="nb">cd </span>log2ram-master
<span class="nb">chmod</span> +x install.sh <span class="o">&amp;&amp;</span> <span class="nb">sudo</span> ./install.sh
<span class="nb">cd</span> ..
<span class="nb">rm</span> <span class="nt">-r</span> log2ram-master
</code></pre></div></div> <p>Now before doing anything else we’ll need to restart the server again <code class="highlighter-rouge">shutdown now -r</code>. After your device has came back up, we’ll need to adjust the log2ram’s configuration by editing the following file <code class="highlighter-rouge">/etc/log2ram.conf</code>. And chance the following:</p> <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Change
</span><span class="py">SIZE</span><span class="p">=</span><span class="s">40M</span>

<span class="c"># Lets increase the RAM log size to 100M
</span><span class="py">SIZE</span><span class="p">=</span><span class="s">100M</span>


<span class="c"># You also want to disbale creating report error mails
</span><span class="py">MAIL</span><span class="p">=</span><span class="s">true</span>
<span class="c"># Change it to falsse
</span><span class="py">MAIL</span><span class="p">=</span><span class="s">false</span>
</code></pre></div></div> <p>I know you’re getting tired of it, but again we’ll need to restart the Pi in order for the new RAM/log configuration to be properly come into effect. <code class="highlighter-rouge">shutdown now -r</code></p> <h2 id="update-raspberry-pis-bootloader">Update Raspberry Pi’s bootloader</h2> <p>If you’re device is pretty fresh out of the box I can almost guarentee you that your Pi will need to have it’s bootloader updated. I’m just going to list the steps take in order to verify and apply a bootloader update</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install </span>rpi-eeprom

<span class="c"># enable checking for bootloader updates</span>
systemctl unmask rpi-eeprom-update

<span class="c"># For the O/S to check for a bootlaoder update</span>
rpi-eeprom-update

<span class="c"># If the results show an update you'll need the Pi to prepare the page for update</span>
rpi-eeprom-update <span class="nt">-a</span>

<span class="c"># In order for the bootloader update to be applied a restart is required</span>
shutdown now <span class="nt">-r</span>
</code></pre></div></div> <p>If you’re device requires an update your results should look similar to the following screenshot.</p> <p><img src="/images/posts/setting_up_a_pihole/bootloader_update.png" alt="Bootloader Update" class="img-fluid sm-w-100"/></p> <h2 id="update-pihole-blocklists">Update PiHole Blocklists</h2> <p>By default the basic list that your Pihole uses is pretty decent it blocks quite a bit of the heavy ad and trackying systems, but I prefer to block more. This is because as I watch my traffic I noticed several of the devices in my houses are still sending requests to various tracking URLs including my smart TV, my kids tablets, my printer, etc.</p> <p><img src="/images/posts/setting_up_a_pihole/pihole_stats.png" alt="Pihole Request Stats" class="img-fluid w-50 sm-w-100"/></p> <p>First you’ll want setup your <a href="https://docs.pi-hole.net/guides/whitelist-blacklist/">blocklist</a> of DNS requests to start blocking as many trackers as you possibly can. My list of blocklists is ended up including about 2 million different links and ends up blocking anywhere between 40-70% of my daily traffic <em>(<a href="https://gist.githubusercontent.com/tarellel/40296f278405e48365cf91b319a9dd3d/raw/af63425d1506dbb03aa47b57aae7ed32bbd7f92a/PiHole_Blocklists.txt">my list of blocklists</a>)</em>. Once you add these lists to your piholes blocklist and update you Pi gravity rating you’ll almost instant notice pages are loading faster and you traffics congestion has been massive reduced.</p> <p>Not lets add some <a href="https://docs.pi-hole.net/ftldns/regex/tutorial/">regex</a> filters to filter out any of those DNS that haven’t been caught by the blocklists. The <a href="https://gist.githubusercontent.com/tarellel/40296f278405e48365cf91b319a9dd3d/raw/af63425d1506dbb03aa47b57aae7ed32bbd7f92a/PiHole_Regex_filers.txt">regex filters I use</a>, I believe I got some piecing together a few reddit posts together. They are specifically setup to catch any DNS requests that have the phrase <code class="highlighter-rouge">tracker, traffic, ads, analytics</code> or various other phrases</p> <p>Next you’ll need to add some your whitelists, mine if a bit liberal and I need to go through and trim it down. But I started out by making it pretty broad, because otherwise spccific services and devices would no longer work on my home network because they uptime ping backs were completely disabled. These included; our xbox, Spotify, updating my kids android devices, updating our LG Smart TV, using our Plex server, Hulu, accessing namecheap, and blocking facebook <em>(which I’d prefer, but my wife can’t list without)</em> from the network. My whitelist can also be found also be found on <a href="https://gist.githubusercontent.com/tarellel/40296f278405e48365cf91b319a9dd3d/raw/af63425d1506dbb03aa47b57aae7ed32bbd7f92a/PiHole_Whitelist.txt">github as a gist</a>. After updating and all all these URL’s and snips to your piholes list, you’ll also want to update and reload your piholes gravity list again. This is to ensure anything added to the whitelist hopefully won’t still be filtered and any regex you added will have hopefully be properly filtered.</p> <h2 id="applications-to-use">Applications to use</h2> <p>In order to VPN into your network <em>(if you want to use the Pihole when outside your network)</em>, you’ll need to download the specified VPN client. If you are using an iPhone you’ll need to use <a href="https://apps.apple.com/us/app/openvpn-connect/id590379981">OpenVPN</a> iOS client, for android you can download the <a href="https://play.google.com/store/apps/details?id=net.openvpn.openvpn">OpenVPN</a> app, and for OSx I used <a href="https://tunnelblick.net/downloads.html">Tunnelblick</a>.</p> <p>In order to use the VPN client on your iPhone you will need to connect it to your computer, similar to how you would sync data between the two or doing a backup. <img src="/images/posts/setting_up_a_pihole/trust_iphone.png" alt="Bootloader Update" class="img-fluid w-50 sm-w-100"/></p> <p>Than on the list of options available for your phone , you need to click the files tab, this will allow you to access the files on your phone. We’ll now need to find the VPN key we generated and <code class="highlighter-rouge">scp</code>‘ed from the Raspberry Pi earlier. And you’ll need to dump it on the OpenVPN application. It may prompt you if you’d like to trust the file be transfered to your phone. Accept it and it should setup the VPN connection configuration for you on your phone.</p> <p><img src="/images/posts/setting_up_a_pihole/iphone_application_list.png" alt="Bootloader Update" class="img-fluid w-3/12 sm-w-100"/></p> <p>This won’t work while you’re in the same network, but if you turn off wifi or connect from outside the network you should be able to connect like the pictures below. (if you added a password to your VPN key you may also need to occasionally input the password before it will allow you to connect or use the key).</p> <p><img src="/images/posts/setting_up_a_pihole/VPN_list.png" alt="List of VPNs on iPhone" class="img-fluid w-3/12 sm-w-100"/> <img src="/images/posts/setting_up_a_pihole/VPN_connected.png" alt="Connected to VPN through the Pi-Hole" class="img-fluid w-3/12 sm-w-100"/></p> <h3 id="references">References</h3> <ul> <li><a href="https://docs.pi-hole.net/">PiHole Documentation</a></li> <li><a href="https://www.raspberrypi.org/documentation/raspbian/">Rasbian Documentation</a></li> </ul> </main> <footer class="space-y-3 text-sm text-center"> <p> Contact me at <a href="mailto:tarellel@gmail.com">tarellel@gmail.com</a> <p/> <p> &copy; 2004 - 2023 Brandon Hicks - All rights reserved.<br> Content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons 4.0 License</a>.<br> Code samples and snippets are licensed under the <a href="https://github.com/tarellel/theworkaround.com/blob/main/LICENSE">MIT License</a> </p> </footer> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41384218-1"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-41384218-1');
    </script> </body> </html>