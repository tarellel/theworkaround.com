<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="Content-Language" content="en"> <title>Mapping an ArcGIS Parcel dataset as a Mapbox tileset | TheWorkAround</title> <meta property="og:title" content="Mapping an ArcGIS Parcel dataset as a Mapbox tileset"/> <meta name="author" content="Brandon"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="This is how I mapped a ArcGIS dataset as a mapbox vector tileset."/> <meta property="og:description" content="This is how I mapped a ArcGIS dataset as a mapbox vector tileset."/> <link rel="canonical" href="https://theworkaround.com/2016/12/15/mapping-an-arcgis-parcel-dataset-as-a-mapbox-tileset/"/> <meta property="og:url" content="https://theworkaround.com/2016/12/15/mapping-an-arcgis-parcel-dataset-as-a-mapbox-tileset/"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2016-12-15T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Mapping an ArcGIS Parcel dataset as a Mapbox tileset"/> <link type="application/atom+xml" rel="alternate" href="https://theworkaround.com/feed.xml" title="TheWorkAround"/> <meta name="author" content="Brandon Hicks"> <meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description."/> <meta name="generator" content="Bridgetown"> <meta name="referrer" content="no-referrer-when-downgrade"> <meta name="robots" content="index, follow"> <link rel="preload" href="/_bridgetown/static/index.SRD7GQPJ.css" as="style"> <link rel="preload" href="/_bridgetown/static/index.HVP7A777.js" as="script"> <link rel="preconnect" href="/" crossorigin> <link rel="preconnect" href="https://rsms.me/inter/inter.css" crossorigin> <link rel="dns-prefetch" href="https://www.googletagmanager.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link rel="stylesheet" href="/_bridgetown/static/index.SRD7GQPJ.css" data-turbo-track="reload"/> <script src="/_bridgetown/static/index.HVP7A777.js" data-turbo-track="reload" defer></script> <link href="https://theworkaround.com/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="https://theworkaround.com/humans.txt" rel="author" type="text/plain"> <link rel="manifest" href="https://theworkaround.com/site.webmanifest"> <link rel="me" href="https://theworkaround.com/" type="text/html"> <link rel="me" href="https://github.com/tarellel"> <link rel="me" href="https://twitter.com/tarellel"> <meta name="theme-color" content="#4cb8c4"> </head> <body class="post antialiased min-h-full font-inter font-normal leading-normal bg-white text-gray-400"> <nav class="border-t-12 border-cyan-600 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4" role="navigation" aria-label="Main"> <div class="text-left"> <h3 class="text-3xl font-extrabold text-gray-600"> <a href="/" class="text-gray-600" title="Goto /" key="home">TheWorkAround</a> </h3> <p class="text-md font-semibold leading-5 text-gray-400">Brandon Hicks</p> </div> <div class="lg:text-right text-lg lg:text-xl flex space-y-4 sm:space-y-0 sm:space-x-9 content-center mt-3 sm:mt-0 flex-col sm:flex-row"> <a href="https://theworkaround.com/about" class="font-semibold text-gray-700 tracking-tight" title="About Me" key="about">About</a> <a href="https://theworkaround.com/posts" class="font-semibold text-gray-700 tracking-tight" title="View a list of all posts" key="posts">Posts</a> <a href="https://theworkaround.com/projects"" class="font-semibold text-gray-700 tracking-tight" title="Projects I'm working on" key="projects">Projects</a> <a href="https://theworkaround.com/feed.xml" class="flex content-center text-orange-600" title="RSS Feed" key="feed"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="h-5 w-5 self-center text-orange-600" class=" h-5 w-5 self-center text-orange-600" alt="RSS Feed Icon" aria-hidden="true" focusable="false" role="img"> <path d="M4 11a9 9 0 0 1 9 9"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <circle cx="5" cy="19" r="1"></circle> </svg> </a> </div> </nav> <main class="post px-10 sm:px-7 border-0"> <h1>Mapping an ArcGIS Parcel dataset as a Mapbox tileset</h1> <p>Before I get begin on how I mapped out several large datasets for <a href="http://sanjuanmaps.com/">SanJuanMaps</a>, I would like to say that there was plenty of <a href="https://www.mapbox.com/gallery/">inspiration</a> behind my actions. I was especially inspired by <a href="https://twitter.com/caged">Justin Palmer’s</a> - <a href="http://labratrevenge.com/pdx/#12/45.4800/-122.6706">The Age of a City</a>. Where he tastefully mapped out all the building ages of Portland, Oregon. But what sets my county maps apart from various other is that I didn’t just map out buildings, people, or objects. I mapped out several sets of data including: building age, building zoning types, current active well sites, and recent crimes.</p> <h2 id="loading-the-parcel-map">Loading the Parcel Map</h2> <p>Depending on your city, state, or county it may be a struggle struggle to get a hold of your local GIS information. But for me, I was able to find my counties GIS information for all buildings (not located on federal and/or local reservation land). It took jumping through a few hoops in order to make the data loadable and usable for processing.</p> <p>To begin San Juan County currently allows you to download a 240MB zip file, thats supposed to contain all GIS information through out the area. This zip file contains numerous files, but the most important one is a <a href="http://www.dbase.com/">dBase</a> file <code class="highlighter-rouge">*.dbf</code>. This database table is linked to several ArcGis index files <code class="highlighter-rouge">*.atx</code>, meaning that each database column has a unique atx file (phys_address, ownerName, ect). Now that we have access to the GIS dataset, there are a few ways we can access the data in which in contains. Now let me ask; who wants to pay <a href="http://www.arcgis.com/features/plans/pricing.html">hundreds</a> of dollars to access a GIS file that’ll we’ll be only using a handful of times? Don’t get me wrong, ArcGIS is one hell of a product and if you plan on working with GIS information often or with large datasets it’s worth it. But since this is a one in a blue moon type thing for me I’ll stick with using <a href="http://www.qgis.org/">QGIS</a>, which is an Open-Source GIS projection application. In order to get the application running there are several components that we’ll require, but in the long run it’s well worth.</p> <p>Now lets= begin with starting up QGIS and opening up the <code class="highlighter-rouge">.dbx</code> file as stated before. Since this is a pretty significant file with a ton of datapoints and components, it will take a few moments for everything to load. Once the parcel project loads, you may be faced with a very intricate map that looks similar to CAD wireframe. Your on the right path, lets slow down for a moment. Now an easy way to think of it, is to consider these map components as vector points similar to using the Pen Tool to build shapes in Adobe Illustrator.</p> <p><img src="/images/posts/mapping_arcgis/gis_grid500.jpg" alt="GIS Grid" class="img-fluid center-block"/></p> <p>Except this GIS map doesn’t just include points to create a layout of buildings (these is quite a bit of meta-data included with each component on the map). If you zoom in and switch to the Identify Features/vector information tool and click individual plots or buildings you’ll notice it allows you to view information for each parcel. Which consists of tons of information used by the county to identify the area (PARCELNO, GrossAcres, PhysAddr, ACCTTYPE, etc.). Now this doesn’t seem like it’ll be anything important, but when we convert the dBase table to a PostGIS table each one of these attributes will be used as a column to identify each and every building throughout the county.</p> <h2 id="understanding-coordinate-reference-systems-and-projections">Understanding Coordinate Reference Systems and Projections</h2> <p><em>~ <strong>Note:</strong> This section is not require to read, but helps with understanding why we need to perform a CRS conversion.</em></p> <p>Before we get started on converting the parcel dataset to a database table, lets talk about <a href="https://docs.qgis.org/2.8/en/docs/gentle_gis_introduction/coordinate_reference_systems.html">Coordinate Reference Systems (CRS)</a>. Wait, why aren’t we just using latitude/longitude? With different maps, we use different coordinate systems. Geographic Coordinate Systems use latitude/longitude and Projected Coordinate Systems use points (X and Y) that originate at a specified lat/long. Think of Projected Coordinate Systems as a window frame, it’s got its one size, area, and dimensions. But no matter how you look at it, all these glass panes end up going together and making one big window.</p> <p>Lets try to look at why there have been several methods developed to map the Earth’s surface (<a href="https://en.wikipedia.org/wiki/Mercator_projection">Mercator</a>, <a href="https://en.wikipedia.org/wiki/Sinusoidal_projection">Flamsteed-Sinusoidal</a>, <a href="https://en.wikipedia.org/wiki/Cylindrical_equal-area_projection">Equal area</a>, <a href="https://en.wikipedia.org/wiki/Azimuthal_equidistant_projection">Equidistant</a>, <a href="https://en.wikipedia.org/wiki/Albers_projection">Albers</a>, <a href="https://en.wikipedia.org/wiki/Lambert_projection">Lambert</a>, and <a href="http://webhelp.esri.com/arcgisdesktop/9.2/index.cfm?TopicName=List_of_supported_map_projections">many more</a>). Now I know what your thinking, “What are all these different projections for? And why would I care?” Throughout the years <a href="https://en.wikipedia.org/wiki/List_of_cartographers">cartographers</a> have experimented with creating projections in which they thought was best for mapping out land, water, cities, and the various features of our planet. And many of them were quite accurate for their time, while others have been slightly <a href="http://www.livescience.com/14754-ingenious-flat-earth-theory-revealed-map.html">narrow minded</a> at depicting the earth.</p> <p>As we can see, it’s no easy task depicting a spherical planet and all of it’s features as a flat surface. This topographical projection types are called an <a href="https://en.wikipedia.org/wiki/Earth_ellipsoid">ellipsoid</a>. No matter what sort of map is used, they have always been an important asset for traveling, freight, military operations, and space travel. Some of these projections are better at depicting land forms, street planning, distances, or scale and accuracy but each one had its place and time. Now the point is, it <a href="http://www.directionsmag.com/site/latlong-converter/">doesn’t matter</a> if your using degrees (25 is degrees, 35 is minutes, and 22.3 is seconds), meters, decimal degrees (25.58952777777778), or whatever plot point method you <em>should</em> always going to end up at approximately the same place.</p> <p>So <a href="https://www.maptoaster.com/maptoaster-topo-nz/articles/projection/datum-projection.html">what is a datum</a>? In my opinion the easiest way to explain a <a href="http://oceanservice.noaa.gov/facts/datum.html">datum</a> is by stating it is a standard or method for mapping geographic coordinates to a projection. A datum can consist of various datasets or an individual GIS vector, but generally consists of a large set of data points to be mapped out (roads, buildings, elevation changes, land formations, water, etc).</p> <p>Mapping with GIS can be a really complicated task, but with the right tools it can make things quite a bit easier.</p> <h2 id="lets-convert-it-to-usable-data">Let’s convert it to usable data</h2> <p>The ArcGIS data in which we obtained through the county is geo-formatted using the <a href="https://en.wikipedia.org/wiki/GRS_80">GRS:80</a> reference system. QGIS will display this and various other attributes when loading up the vector map projection. When looking at the data you should see something similar to the following attributes upon loading up the map.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">USER</span><span class="p">:</span><span class="mi">1000001</span> <span class="p">(</span><span class="o">*</span> <span class="nx">Generated</span> <span class="nx">CRS</span> <span class="p">(</span><span class="o">+</span><span class="nx">proj</span><span class="o">=</span><span class="nx">tmerc</span> <span class="o">+</span><span class="nx">lat_0</span><span class="o">=</span><span class="mi">31</span> <span class="o">+</span><span class="nx">lon_0</span><span class="o">=-</span><span class="mf">107.8333333333333</span> <span class="o">+</span><span class="nx">k</span><span class="o">=</span><span class="mf">0.9999166666666667</span> <span class="o">+</span><span class="nx">x_0</span><span class="o">=</span><span class="mf">829999.9999999998</span> <span class="o">+</span><span class="nx">y_0</span><span class="o">=</span><span class="mi">0</span> <span class="o">+</span><span class="nx">ellps</span><span class="o">=</span><span class="nx">GRS80</span> <span class="o">+</span><span class="nx">towgs84</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="o">+</span><span class="nx">units</span><span class="o">=</span><span class="nx">us</span><span class="o">-</span><span class="nx">ft</span> <span class="o">+</span><span class="nx">no_defs</span><span class="p">))</span>
</code></pre></div></div> <p>We are now very much on our way to having a data projection of usable data for mapping out the county. The only issue we are going to have at this point is the majority of online mapping tools use the <a href="https://confluence.qps.nl/pages/viewpage.action?pageId=29855173">EPSG:4326/WGS84</a> standard for projecting data. This can easy be achieved by reprojecting the layer with WGS84 coordinates. <strong>Go To:</strong> <code class="highlighter-rouge">Menu -&gt; Processing -&gt; Toolbox -&gt; QGIS geoalgorithms -&gt; Vector General Tools -&gt; Reproject Layer</code>. Another method is if you have the Toolbox side already open you can just search for the tool <code class="highlighter-rouge">Reproject Layer</code></p> <p><img src="/images/posts/mapping_arcgis/reproject_layer.png" alt="Reprojected Layer" class="img-fluid center-block"/></p> <p>You than set the “Target CRS” as EPSG:4326/WGS84 in the dropdown menu, but we warned depending on your computer this may take a while. Because some of the structures have numerous repetitive points, I had to reduce the point precision in order to keep my computer from freezing up when I would reproject the layer. This can be be found in the toolbox under <code class="highlighter-rouge">Grass -&gt; Vector -&gt; v.clean</code>. Be warned if you do need to use this feature, I suggest that you use it sparingly because it can and will readjust the boundaries of various structures.</p> <p>Now lets save the data as a <a href="https://en.wikipedia.org/wiki/Well-known_text">WTK</a> CSV file, to make it easier to load all the counties properties and their attributes into a database. To do this, rather than saving the project you right-click the Layer and Save-As. From here make sure you need to change the CRS to <code class="highlighter-rouge">Default CRS (EPSG:4326 - WGS 84)</code> and that the format is <code class="highlighter-rouge">CSV</code>. The next important thing is to force the Geomerty to be expost as <code class="highlighter-rouge">AS_WKT</code> and the CSV seperator is <code class="highlighter-rouge">COMMA</code>. Now saving may take a while, because there’s quite a few properties that need to have its properties converted to csv.</p> <p>Many people may not realize it, but CSV files aren’t just large datafiles that you can open up in excel. If you think about, it’s pretty much a plain text database file. It’s a pretty efficient way for accessing data but it can be bulking and slow depending on your editor. With 81000 or so rows, it locks up and freezes <a href="https://atom.io/">Atom</a> and it even slows down <a href="https://www.sublimetext.com/3">Sublime</a> significantly, with 16gb of RAM. But we’re not going to be editing them in an IDE, we’ll be loading them in <a href="https://postgresapp.com/">Postgres</a>. This because Postgres supports <a href="http://postgis.net/">GIS</a> data structures and is very efficient at processing large amounts of data.</p> <p>Before we import the data into Postgres, we need to insure we have proper table structure. And at the moment, one of my favorite tools for building database into out of CSV files by using <a href="https://csvkit.readthedocs.io/en/0.9.1/index.html">csvkit</a>. If you’ve never used it, it lets you print column names, convert CSV to JSON, reorder columns, import to SQL, and much more.</p> <p>Now normally we’d just attempt to build the database scheme with the following command.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>csvsql <span class="nt">-i</span> postgresql Buildings.csv
</code></pre></div></div> <p>But since there are so many rows, the python script will probably freeze up or start consuming a HUGE amount of memory. So in order to make it more efficient, we’ll get the first 20 rows of data. And using command line piping we’ll send the data to the csv tool for processing.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">head</span> <span class="nt">-n</span> 20 Buildings.csv | csvsql <span class="nt">--no-constraints</span> <span class="nt">--table</span> buildings
</code></pre></div></div> <p>Depending on the information available, your SQL output should be something similar to the following. Several of these columns we’ll never even use, but for now it’s better to not chance corrupting any of our fields. Before you go any farther be sure to change the geometry field names to geom and if CSVKIT labels geom as a VARCHAR for the geometry property type.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"buildings"</span> <span class="p">(</span>
  <span class="n">geom</span> <span class="n">geometry</span><span class="p">,</span>
  <span class="n">ogc_fid</span> <span class="nb">INTEGER</span><span class="p">,</span>
  <span class="n">parcelno</span> <span class="nb">BIGINT</span><span class="p">,</span>
  <span class="n">accountno</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">book</span> <span class="nb">INTEGER</span><span class="p">,</span>
  <span class="n">page</span> <span class="nb">INTEGER</span><span class="p">,</span>
  <span class="n">grossacres</span> <span class="nb">FLOAT</span><span class="p">,</span>
  <span class="n">accttype</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">ownername</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">ownername2</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">owneraddr</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">ownctystzp</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">subdivis</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">legaldesc</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">legaldesc2</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">weblink</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">physaddr</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">physcity</span> <span class="nb">VARCHAR</span><span class="p">,</span>
  <span class="n">physzip</span> <span class="nb">VARCHAR</span>
<span class="p">);</span>
</code></pre></div></div> <p><strong>NOTE</strong>: Depending on the GIS software you used, I had various issues with the CSV file that I needed to correct before importing it. The issues that we’ll encounter involve the geometry field. Since CSV fields are separated by commas Postgres tries to import the polygons coordinates as separate columns as well.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">POLYGON</span> <span class="p">((</span><span class="o">-</span><span class="mi">108</span><span class="p">.</span><span class="mi">195455993822</span> <span class="mi">36</span><span class="p">.</span><span class="mi">979941009114</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2075189351198</span><span class="p">,</span><span class="n">R0051867</span><span class="p">,,,</span><span class="mi">57</span><span class="p">.</span><span class="mi">06</span><span class="p">,</span><span class="n">EXEMPT</span><span class="p">,</span><span class="n">UNITED</span> <span class="n">STATES</span> <span class="k">OF</span> <span class="n">AMERICA</span> <span class="n">US</span> <span class="n">DEPT</span> <span class="k">OF</span> <span class="n">INTE</span><span class="p">,,</span><span class="mi">6251</span> <span class="n">COLLEGE</span> <span class="n">BLVD</span> <span class="n">STE</span> <span class="n">A</span><span class="p">,</span><span class="nv">"FARMINGTON, NM 87402"</span><span class="p">,,</span><span class="n">A</span> <span class="n">TRACT</span> <span class="k">OF</span> <span class="n">LAND</span> <span class="k">IN</span> <span class="n">THE</span>  <span class="n">SESW</span> <span class="k">AND</span> <span class="n">NESW</span> <span class="k">AND</span> <span class="n">NWSE</span> <span class="k">OF</span> <span class="mi">153213</span> <span class="n">DESCRIBED</span> <span class="k">ON</span> <span class="n">PERM</span> <span class="n">CARD</span>  <span class="n">BK</span><span class="p">.</span><span class="mi">1172</span> <span class="n">PG</span><span class="p">.</span><span class="mi">996</span><span class="p">,,</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">propery</span><span class="p">.</span><span class="n">url</span><span class="p">,</span><span class="n">NM</span> <span class="mi">170</span><span class="p">,</span><span class="n">LA_PLATA</span><span class="p">,</span>
</code></pre></div></div> <p>In order to fix this, we need to quote the geometry column in order to make it a field of it’s own. With Sublime’s find/replace REGEX functionality this would be very straight forward step. In order to find the rows with the issue, I used the following <code class="highlighter-rouge">^(?!"POLYGON)</code>. Out of 81000 or so columns, there were only a few hundred rows with this issue that needed to be changed.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">"POLYGON ((-108.195455993822 36.979941009114,-108.195717330387 36.987213809214,-108.19557299488 36.987214765187))"</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2075189351198</span><span class="p">,</span><span class="n">R0051867</span><span class="p">,,,</span><span class="mi">57</span><span class="p">.</span><span class="mi">06</span><span class="p">,</span><span class="n">EXEMPT</span><span class="p">,</span><span class="n">UNITED</span> <span class="n">STATES</span> <span class="k">OF</span> <span class="n">AMERICA</span> <span class="n">US</span> <span class="n">DEPT</span> <span class="k">OF</span> <span class="n">INTE</span><span class="p">,,</span><span class="mi">6251</span> <span class="n">COLLEGE</span> <span class="n">BLVD</span> <span class="n">STE</span> <span class="n">A</span><span class="p">,</span><span class="nv">"FARMINGTON, NM 87402"</span><span class="p">,,</span><span class="n">A</span> <span class="n">TRACT</span> <span class="k">OF</span> <span class="n">LAND</span> <span class="k">IN</span> <span class="n">THE</span>  <span class="n">SESW</span> <span class="k">AND</span> <span class="n">NESW</span> <span class="k">AND</span> <span class="n">NWSE</span> <span class="k">OF</span> <span class="mi">153213</span> <span class="n">DESCRIBED</span> <span class="k">ON</span> <span class="n">PERM</span> <span class="n">CARD</span>  <span class="n">BK</span><span class="p">.</span><span class="mi">1172</span> <span class="n">PG</span><span class="p">.</span><span class="mi">996</span><span class="p">,,</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">propery</span><span class="p">.</span><span class="n">url</span><span class="p">,</span><span class="n">NM</span> <span class="mi">170</span><span class="p">,</span><span class="n">LA_PLATA</span><span class="p">,</span>
</code></pre></div></div> <h3 id="importing-the-data-into-postgres">Importing the data into Postgres</h3> <p>Now before we import the dataset, lets enable the <a href="http://postgis.net/">PostGIS</a> extension so the database can process the buildings vectors properly.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">postgis</span><span class="p">;</span>
</code></pre></div></div> <p>Now depending on how your managing your database, you either import the CSV file through pgAdmin or through the command line. I chose the the command line, because of its speed and convenience.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">copy</span> <span class="n">buildings</span> <span class="k">FROM</span> <span class="s1">'/Users/Tarellel/Desktop/SJC_GIS/Exported/Buildings.csv'</span> <span class="k">DELIMITER</span> <span class="s1">','</span> <span class="n">CSV</span> <span class="n">HEADER</span><span class="p">;</span>
</code></pre></div></div> <p>Compared to loading data in IDE’s and/or Excel, Postgres is extremely fast at accessing, modifying, and deleting rows, columns, and fields. Depending on what data you plan on mapping you may not need to make any additional changes. I’m going to be mapping out all building ages in the county, so I needed to add the <code class="highlighter-rouge">built_in</code> column to the table, for the year in which the structure was built.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">buildings</span> <span class="k">ADD</span> <span class="n">built_in</span> <span class="nb">integer</span><span class="p">;</span>
</code></pre></div></div> <p>If you’re like me, you probably already started doing queries to verify the integrity of the information imported. Something you may notice is that the structures geometry field no longer looks like <code class="highlighter-rouge">"POLYGON ((-108.195455993822 36.979941009114,-108.195717330387 36.987213809214,-108.19557299488 36.987214765187))"</code>. That is because PostGIS stores the locations as a binary specification, but when queried the information is viewed as a hex-encoded string. This makes it easier for PostGIS to store and project the data as various data projection formats.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">geom</span> <span class="k">FROM</span> <span class="n">buildings</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">--------------------</span>
<span class="mi">01030000000100000005000000</span><span class="n">F9A232DD00065BC034E0D442D7594240F0567E50FB055BC094B9B760D55942409E97C29CFE055BC0CAC4E0D8BB594240080B801404065BC0440327CEBD594240F9A232DD00065BC034E0D442D7594240</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
<span class="c1">--------------------</span>
</code></pre></div></div> <h3 id="lets-fetch-the-buildproperties-initial-build-date">Lets fetch the build/properties initial build date</h3> <p>In order to get each and every buildings initial build date, I ended up using nokogiri to scan the county assessors property listings for their initial build dates. Don’t get me wrong, I tried to look for an easy way to get the information. But they have no publicly accessible API for pulling data requests and never received a response from anyone I attempted to contact. So, I used the next best thing, farmed the counties web site for property listing information.</p> <p><em>For warning,</em> This script was build to be quick and simple solution, rather than being well formatted and following best practices.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'pg'</span>
<span class="nb">require</span> <span class="s1">'open-uri'</span>
<span class="nb">require</span> <span class="s1">'nokogiri'</span>
<span class="nb">require</span> <span class="s1">'restclient'</span>

<span class="c1"># Fetch current buildings across the County and determine their build date</span>
<span class="k">class</span> <span class="nc">FetchYear</span>
  <span class="vi">@conn</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="c1">###</span>
  <span class="c1"># Setup initial required variables, for processing all properties</span>
  <span class="c1"># ----------</span>
  <span class="c1"># A connection to the database is required for request and updates</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@conn</span> <span class="o">=</span> <span class="no">PG</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">dbname: </span><span class="s1">'SJC_Properties'</span><span class="p">)</span>
    <span class="vi">@base_link</span> <span class="o">=</span> <span class="s1">'http://county_assessor.url'</span>
  <span class="k">end</span>

  <span class="c1">###</span>
  <span class="c1"># Fetches the next X(number) of buildings</span>
  <span class="c1"># all selects require that built_in year field to be empty, to prevent an infinite loop</span>
  <span class="k">def</span> <span class="nf">fetch_buildings</span>
    <span class="vi">@conn</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="s1">'SELECT * FROM buildings WHERE weblink IS NOT NULL AND built_in IS NULL AND built_in != 0 LIMIT 50'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">results</span><span class="o">|</span>
      <span class="c1"># if any results are found, begin processing them to get the properties link/year build</span>
      <span class="k">if</span> <span class="n">results</span><span class="p">.</span><span class="nf">any?</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
          <span class="c1"># for some reason, some buildings are empty on most fields</span>
          <span class="c1"># if no weblink is supplied, skip it</span>
          <span class="c1"># ie: "parcelno"=&gt;"2063170454509"</span>
          <span class="k">next</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">'weblink'</span><span class="p">].</span><span class="nf">nil?</span>
          <span class="n">link</span><span class="p">,</span> <span class="n">built_in</span> <span class="o">=</span> <span class="s1">''</span>
          <span class="n">link</span> <span class="o">=</span> <span class="n">fetch_weblink</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
          <span class="n">link</span> <span class="o">||=</span> <span class="s1">''</span>

          <span class="c1"># Attempt to fetch the properties build_date</span>
          <span class="c1"># Note: some properties are EXEMPT and/or Vacacent</span>
          <span class="c1"># so no built_date will be specified</span>
          <span class="n">built_in</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="n">fetch_yearbuilt</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
          <span class="n">update_build_year</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">built_in</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="nb">puts</span> <span class="s1">'It appears all database rows have been processed'</span>
        <span class="nb">abort</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># Private: Fetches the properties unique information URI from the requested</span>
  <span class="c1"># SJC assessors page</span>
  <span class="c1"># ----------------------------------------</span>
  <span class="c1"># building - all attributes for the current building/residence being processed</span>
  <span class="c1"># Returns: Returns the properties unique information UIR</span>
  <span class="k">def</span> <span class="nf">fetch_weblink</span><span class="p">(</span><span class="n">building</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># If it processes successfully attempt to load the Redidental/Commercial page</span>
    <span class="c1"># Other output the error</span>
    <span class="k">begin</span>
      <span class="c1"># Page required the visitor be logged in as a guest, with a GET form request</span>
      <span class="n">page</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span>
                <span class="no">RestClient</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
                  <span class="n">building</span><span class="p">[</span><span class="s1">'weblink'</span><span class="p">],</span>
                  <span class="ss">cookies: </span><span class="p">{</span> <span class="ss">isLoggedInAsPublic: </span><span class="s1">'true'</span> <span class="p">}</span>
                <span class="p">)</span>
              <span class="p">)</span>

      <span class="c1"># Each property contains a unique URL similar to:</span>
      <span class="c1"># http://county_assessor.url/account.jsp?accountNum=R0070358&amp;doc=R0070358.COMMERCIAL1.1456528185534</span>
      <span class="c1"># Winthin the left sidebar there is a link table that contains the accttype</span>
      <span class="c1"># and based on the accttype/property-type each link will be different</span>
      <span class="k">case</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="s1">'accttype'</span><span class="p">])</span>
      <span class="c1"># Select the property when it is a class of Residential</span>
      <span class="k">when</span> <span class="s1">'RESIDENTIAL'</span><span class="p">,</span> <span class="s1">'MULTI_FAMILY'</span><span class="p">,</span> <span class="s1">'RES_MIX'</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">page</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'#left'</span><span class="p">).</span><span class="nf">xpath</span><span class="p">(</span><span class="s1">'//a[contains(text(), "Residential")]'</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="s1">'a[href]'</span><span class="p">)</span>

      <span class="c1"># Process Commercial based Properties</span>
      <span class="k">when</span> <span class="s1">'COMMERCIAL'</span><span class="p">,</span> <span class="s1">'COMM_MIX'</span><span class="p">,</span> <span class="s1">'MH_ON_PERM'</span><span class="p">,</span> <span class="s1">'PARTIAL_EXEMPT'</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">page</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'#left'</span><span class="p">).</span><span class="nf">xpath</span><span class="p">(</span><span class="s1">'//a[contains(text(), "Commercial/Ag")]'</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="s1">'a[href]'</span><span class="p">)</span>

      <span class="c1"># Some Vacant and EXEMPT properties only have land listed with no building data available</span>
      <span class="c1"># When this is the case or default to no type, return a 0.</span>
      <span class="c1"># Because no building info is currently available</span>
      <span class="k">when</span> <span class="s1">'EXEMPT'</span><span class="p">,</span> <span class="s1">'VACANT_LAND'</span><span class="p">,</span> <span class="s1">'AGRICULTURAL'</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="s1">''</span>
      <span class="k">end</span>

      <span class="c1"># Some properties have several links, pull the first/original building info</span>
      <span class="n">first_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="k">if</span> <span class="o">!</span><span class="n">link</span><span class="p">.</span><span class="nf">empty?</span>

    <span class="k">rescue</span> <span class="no">OpenURI</span><span class="o">::</span><span class="no">HTTPError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s1">'404 Not Found'</span>
        <span class="nb">puts</span> <span class="s1">'Page not found'</span>
      <span class="k">else</span>
        <span class="nb">puts</span> <span class="s1">'Error loading this page'</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">fetch_yearbuilt</span><span class="p">(</span><span class="n">link</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">''</span> <span class="k">if</span> <span class="n">link</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="k">begin</span>
      <span class="c1"># Load the URL for the buildings summary</span>
      <span class="n">summary</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span>
                  <span class="no">RestClient</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
                    <span class="n">link</span><span class="p">,</span>
                    <span class="ss">cookies: </span><span class="p">{</span> <span class="ss">isLoggedInAsPublic: </span><span class="s1">'true'</span> <span class="p">}</span>
                  <span class="p">)</span>
                <span class="p">)</span>
      <span class="n">yearbuilt</span> <span class="o">=</span> <span class="n">summary</span><span class="p">.</span><span class="nf">css</span><span class="p">(</span><span class="s1">'tr'</span><span class="p">).</span><span class="nf">xpath</span><span class="p">(</span><span class="s1">'//span[contains(text(), "Actual Year Built")]'</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">parent</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'span'</span><span class="p">).</span><span class="nf">last</span><span class="p">.</span><span class="nf">content</span>

      <span class="c1"># year must be stripped and turned into an into an integer</span>
      <span class="c1"># because it trails with an invisible space '&amp;nbsp;'</span>
      <span class="n">yearbuilt</span><span class="p">.</span><span class="nf">strip</span><span class="p">.</span><span class="nf">to_i</span>
    <span class="k">rescue</span> <span class="no">OpenURI</span><span class="o">::</span><span class="no">HTTPError</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="nb">puts</span> <span class="s1">'--------------------'</span>
      <span class="nb">puts</span> <span class="s1">'Error loading property summary page'</span>
      <span class="nb">puts</span> <span class="s2">"URL: </span><span class="si">#{</span><span class="n">link</span><span class="si">}</span><span class="s2">"</span>
      <span class="nb">puts</span> <span class="s1">'--------------------'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1">###</span>
  <span class="c1"># Process the current link:</span>
  <span class="c1"># ----------</span>
  <span class="c1"># some properties have their attctype listed several times causing errors when processing</span>
  <span class="c1"># this is because of upgrades or additions added to the current property</span>
  <span class="c1"># Returns the first link for the property array</span>
  <span class="k">def</span> <span class="nf">first_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
    <span class="n">link</span><span class="p">.</span><span class="nf">length</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">?</span> <span class="vi">@base_link</span> <span class="o">+</span> <span class="n">link</span><span class="p">.</span><span class="nf">attribute</span><span class="p">(</span><span class="s1">'href'</span><span class="p">).</span><span class="nf">to_s</span> <span class="p">:</span> <span class="vi">@base_link</span> <span class="o">+</span> <span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">attribute</span><span class="p">(</span><span class="s1">'href'</span><span class="p">).</span><span class="nf">to_s</span>
  <span class="k">end</span>

  <span class="c1">###</span>
  <span class="c1"># Update the database record with the year it was built</span>
  <span class="c1"># ----------</span>
  <span class="c1"># record (hash): The current record/addr in which to update</span>
  <span class="c1"># year (int): This will be the year/value that needs to be updated in the record</span>
  <span class="k">def</span> <span class="nf">update_build_year</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="s1">'0'</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">record</span><span class="p">[</span><span class="s1">'accountno'</span><span class="p">]</span><span class="si">}</span><span class="s2"> &gt;/ </span><span class="si">#{</span><span class="n">record</span><span class="p">[</span><span class="s1">'physaddr'</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">"</span>
    <span class="vi">@conn</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="s2">"UPDATE buildings SET built_in=</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2"> WHERE accountno='</span><span class="si">#{</span><span class="n">record</span><span class="p">[</span><span class="s1">'accountno'</span><span class="p">]</span><span class="si">}</span><span class="s2">' AND physaddr='</span><span class="si">#{</span><span class="n">record</span><span class="p">[</span><span class="s1">'physaddr'</span><span class="p">]</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">fetch</span> <span class="o">=</span> <span class="no">FetchYear</span><span class="p">.</span><span class="nf">new</span>
<span class="mi">500</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">fetch</span><span class="p">.</span><span class="nf">fetch_buildings</span>
<span class="k">end</span>
</code></pre></div></div> <p>I ran this script over night and came back with a fully populated database and ready for to be fully utilized. Depending on the server load, each request usually took a few seconds for each building/property. But one thing that really surprised me, was the counties server had no rate-limiting setup (at least non that I ever experiences). So I was getting results as fast as my script could run and connect. I’m sure the next morning it might of looked like a small DDOS attack by a script kiddy with thousands of page loads from a single source. But I tried to minimize the effect by doing all my data retrieval in the middle of the night, when it would have as little effect as possible.</p> <h3 id="how-the-script-works">How the Script Works</h3> <p>Now, before you start scratching your head thinking “what the hell?” let me explain. Each and every property has a unique weblink associated with the count assessors office. When you access the page a cookie <code class="highlighter-rouge">isLoggedInAsPublic</code> is set to true, using a get request. I believe this is used in order to prevent general web scraping, because if the cookie isn’t set when the page is loaded redirected to a user login.</p> <p>I know it looks like a mess and over complicated by let me explain a few things. But some of the properties are owned by the same owner so we can’t exactly relay on the <code class="highlighter-rouge">accountno</code> to update properties. And we can’t use <code class="highlighter-rouge">physaddr</code> because some properties have more than one building on them, so we rely on updating several properties.</p> <p>And what about the EXEMPT and Vacant properties? Well the majority of them consists of Churches, Post Offices, Government Buildings, the Airport, and unclassified BLM land. And yes there are quite a few in the generate area. This is the surrounding area is heavily funded by the government, we’re also a city bordering the edge of several reservations.</p> <h3 id="lets-convert-it-to-a-geojson-file-for-vectoring">Lets convert it to a GeoJson file for vectoring</h3> <p>For those of you who have never used used it, Postgres has amazing support for exporting data as <a href="http://www.json.org/">json</a>. Some people seem to be unaware that you can resolve to exporting your database queries in different data formats. And some databases (such as Postgres) also allow you to export your database query returns to various file formats.</p> <p>I can assure you, I didn’t get this right on the first even second try. I’ll honestly admit it took me a few hours to build a query that use the columns I required and would export as a valid <a href="http://geojson.org/">GeoJson</a> format. I’d say I probably rebuild the query maybe 20 times, each one being completely different each and everyone. But in the end, I ended up with a swatch of subqueries and assignments that ended exporting the data extremely fast and well structured. As you can see below, the query may look like a complicated mess. The funny thing is, it’s a heck of a lot simpler than some of the other query selections I ended up trying to come up with.</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">row_to_json</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
  <span class="k">FROM</span><span class="p">(</span>
    <span class="k">SELECT</span>
      <span class="s1">'FeatureCollection'</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span>
      <span class="n">array_to_json</span><span class="p">(</span><span class="n">array_agg</span><span class="p">(</span><span class="n">feature</span><span class="p">))</span> <span class="k">AS</span> <span class="n">features</span>
    <span class="k">FROM</span><span class="p">(</span>
      <span class="k">SELECT</span>
        <span class="s1">'Feature'</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span>
        <span class="n">row_to_json</span><span class="p">(</span>
          <span class="p">(</span><span class="k">SELECT</span> <span class="n">l</span> <span class="k">FROM</span>
            <span class="p">(</span><span class="k">SELECT</span> <span class="n">initcap</span><span class="p">(</span><span class="n">accttype</span><span class="p">)</span> <span class="k">AS</span> <span class="k">type</span><span class="p">,</span> <span class="n">built_in</span><span class="p">)</span> <span class="k">AS</span> <span class="n">l</span><span class="p">)</span>
        <span class="p">)</span> <span class="k">AS</span> <span class="n">properties</span><span class="p">,</span>
        <span class="n">ST_AsGeoJSON</span><span class="p">(</span><span class="n">lg</span><span class="p">.</span><span class="n">geom</span><span class="p">)::</span><span class="n">json</span> <span class="k">AS</span> <span class="n">geometry</span>
      <span class="k">FROM</span>
        <span class="n">buildings</span> <span class="k">AS</span> <span class="n">lg</span>
      <span class="k">WHERE</span>
        <span class="n">geom</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
      <span class="p">)</span> <span class="k">AS</span> <span class="n">feature</span>
  <span class="p">)</span> <span class="k">AS</span> <span class="n">collection</span>
<span class="p">)</span> <span class="k">TO</span> <span class="s1">'/Users/Tarellel/Desktop/buildings.json'</span><span class="p">;</span>
</code></pre></div></div> <p>Just a heads up you may be expecting a nice and beautiful json structure similar to the following.</p> <p><small>Example from <em><a href="http://geojson.org/geojson-spec.html">geojson-spec data</a></em></small></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FeatureCollection"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Feature"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"geometry"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Point"</span><span class="p">,</span><span class="w"> </span><span class="nl">"coordinates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">102.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">]},</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"prop0"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value0"</span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Feature"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"geometry"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LineString"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"coordinates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">[</span><span class="mf">102.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">103.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">104.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">105.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">},</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"prop0"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value0"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"prop1"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Feature"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"geometry"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
           </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Polygon"</span><span class="p">,</span><span class="w">
           </span><span class="nl">"coordinates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
             </span><span class="p">[</span><span class="w"> </span><span class="p">[</span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">101.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">101.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">],</span><span class="w">
               </span><span class="p">[</span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
             </span><span class="p">]</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
           </span><span class="nl">"prop0"</span><span class="p">:</span><span class="w"> </span><span class="s2">"value0"</span><span class="p">,</span><span class="w">
           </span><span class="nl">"prop1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"this"</span><span class="p">:</span><span class="w"> </span><span class="s2">"that"</span><span class="p">}</span><span class="w">
           </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
       </span><span class="p">]</span><span class="w">
     </span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>The query I used ends exporting the data more like a crunched dataset. Which is great because it dramatically reduces filesize and is a must when optimizing for loading on webpages. Plus no matter how you use it, it’s not like whatever processor your using is really going to worry about how beautiful your file is, as long as the data is valid.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"FeatureCollection"</span><span class="p">,</span><span class="nl">"features"</span><span class="p">:[{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Feature"</span><span class="p">,</span><span class="nl">"geometry"</span><span class="p">:{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Point"</span><span class="p">,</span><span class="nl">"coordinates"</span><span class="p">:[</span><span class="mi">102</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]},</span><span class="nl">"properties"</span><span class="p">:{</span><span class="nl">"prop0"</span><span class="p">:</span><span class="s2">"value0"</span><span class="p">}},{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Feature"</span><span class="p">,</span><span class="nl">"geometry"</span><span class="p">:{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"LineString"</span><span class="p">,</span><span class="nl">"coordinates"</span><span class="p">:[[</span><span class="mi">102</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">103</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">104</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">105</span><span class="p">,</span><span class="mi">1</span><span class="p">]]},</span><span class="nl">"properties"</span><span class="p">:{</span><span class="nl">"prop0"</span><span class="p">:</span><span class="s2">"value0"</span><span class="p">,</span><span class="nl">"prop1"</span><span class="p">:</span><span class="mi">0</span><span class="p">}},{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Feature"</span><span class="p">,</span><span class="nl">"geometry"</span><span class="p">:{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"Polygon"</span><span class="p">,</span><span class="nl">"coordinates"</span><span class="p">:[[[</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">101</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">101</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">]]]},</span><span class="nl">"properties"</span><span class="p">:{</span><span class="nl">"prop0"</span><span class="p">:</span><span class="s2">"value0"</span><span class="p">,</span><span class="nl">"prop1"</span><span class="p">:{</span><span class="nl">"this"</span><span class="p">:</span><span class="s2">"that"</span><span class="p">}}}]}</span><span class="w">
</span></code></pre></div></div> <p>Now that you’ve exported the dataset as a GeoJson file, it’s all downhill from here. You’ll just need to use the Mapbox <a href="https://www.mapbox.com/api-documentation/#uploads">upload API</a> to upload the file. From here you can edit and <a href="https://www.mapbox.com/help/getting-started-studio-datasets/">style</a> the data and vector points the way in which you see fit.</p> <hr/> <h3 id="references">References</h3> <ul> <li>Coordinate Reference Systems <ul> <li><a href="https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf">Overview of Coordinate Reference Systems</a></li> <li><a href="http://docs.qgis.org/2.0/en/docs/gentle_gis_introduction/coordinate_reference_systems.html">Understanding of Coordinate Reference Systems</a></li> <li><a href="https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf">Overview of Coordinate Reference Systems</a></li> <li><a href="http://www.ogcnetwork.net/node/338">Latitude and longitude coordinates are not unique</a></li> <li><a href="http://gis.stackexchange.com/questions/23690/is-wgs84-itself-a-coordinate-reference-system">Is WGS84 itself a Coordinate Reference System?</a></li> <li><a href="http://www.ogcnetwork.net/webgeoformats">Web-Friendly Geo formats</a></li> <li><a href="https://en.wikipedia.org/wiki/Spatial_reference_system">Spatial_reference_system</a></li> <li><a href="https://en.wikipedia.org/wiki/Geodetic_datum">Geodetic datum</a></li> <li><a href="http://gis.stackexchange.com/questions/664/whats-the-difference-between-a-projection-and-a-datum">What’s the difference between a projection and a datum?</a></li> </ul> </li> <li>Round Earth, Flat Maps <ul> <li><a href="http://piecubed.co.uk/flat-world-map-lies/">Maps are all lies – Representing a spherical earth on a flat world map</a></li> <li><a href="http://www.nationalgeographic.com/features/2000/projections/">Round Earth, Flat Maps (National Geographic)</a></li> <li><a href="http://www.icsm.gov.au/mapping/images/MapProjections.pdf">Map Projections: From Spherical Earth to Flat Map</a></li> <li><a href="http://www.progonos.com/furuti/MapProj/Normal/CartHow/HowSanson/howSanson.html">Deducing the Sanson-Flamsteed (sinusoidal) Projection</a></li> <li><a href="http://www.progonos.com/furuti/MapProj/Dither/CartProp/DistPres/distPres.html">Useful Map Properties: Distances and Scale</a></li> </ul> </li> <li>GIS : Coordinate Converters <ul> <li><a href="http://webhelp.esri.com/arcgisdesktop/9.2/index.cfm?TopicName=Converting_Degrees_Minutes_Seconds_values_to_Decimal_Degree_values">Converting Degrees Minutes Seconds values to Decimal Degree values</a></li> <li><a href="http://www.pgc.umn.edu/tools/conversion">PGC Coordinate Converter</a></li> </ul> </li> <li>GeoForms <ul> <li><a href="http://www.ogcnetwork.net/webgeoformats">Web-Friendly Geo formats</a></li> </ul> </li> <li>Postgres / PostGIS <ul> <li><a href="http://www.bostongis.com/PrinterFriendly.aspx?content_name=postgis_tut01">Getting Started With PostGIS</a></li> </ul> </li> </ul> </main> <footer class="space-y-3 text-sm text-center"> <p> Contact me at <a href="mailto:tarellel@gmail.com">tarellel@gmail.com</a> <p/> <p> &copy; 2022 Brandon Hicks - All rights reserved </p> </footer> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41384218-1"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-41384218-1');
    </script> </body> </html>