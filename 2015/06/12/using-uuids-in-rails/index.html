<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="Content-Language" content="en"> <title>Using UUIDs in Rails | TheWorkAround</title> <meta property="og:title" content="Using UUIDs in Rails"/> <meta name="author" content="Brandon"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="A quick explanation on how to generate UUIDs in Rails while using the Postgres and SQLite databases"/> <meta property="og:description" content="A quick explanation on how to generate UUIDs in Rails while using the Postgres and SQLite databases"/> <link rel="canonical" href="https://theworkaround.com/2015/06/12/using-uuids-in-rails/"/> <meta property="og:url" content="https://theworkaround.com/2015/06/12/using-uuids-in-rails/"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2015-06-12T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Using UUIDs in Rails"/> <link type="application/atom+xml" rel="alternate" href="https://theworkaround.com/feed.xml" title="TheWorkAround"/> <meta name="author" content="Brandon Hicks"> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta name="generator" content="Bridgetown"> <meta name="referrer" content="no-referrer-when-downgrade"> <meta name="robots" content="index, follow"> <link rel="preload" href="/_bridgetown/static/index.RWK2IEWH.css" as="style"> <link rel="preload" href="/_bridgetown/static/index.HVP7A777.js" as="script"> <link rel="preconnect" href="/" crossorigin> <link rel="preconnect" href="https://rsms.me/inter/inter.css" crossorigin> <link rel="dns-prefetch" href="https://www.googletagmanager.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link rel="stylesheet" href="/_bridgetown/static/index.RWK2IEWH.css" data-turbo-track="reload"/> <script src="/_bridgetown/static/index.HVP7A777.js" data-turbo-track="reload" defer></script> <link href="https://theworkaround.com/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="https://theworkaround.com/humans.txt" rel="author" type="text/plain"> <link rel="manifest" href="https://theworkaround.com/site.webmanifest"> <link rel="me" href="https://theworkaround.com/" type="text/html"> <link rel="me" href="https://github.com/tarellel"> <link rel="me" href="https://twitter.com/tarellel"> <meta name="theme-color" content="#4cb8c4"> </head> <body class="post antialiased min-h-full font-inter font-normal leading-normal bg-white text-gray-400"> <nav class="border-t-12 border-cyan-600 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4" role="navigation" aria-label="Main"> <div class="text-left"> <h3 class="text-3xl font-extrabold text-gray-600"> <a href="/" class="text-gray-600" title="Goto /" key="home">TheWorkAround</a> </h3> <p class="text-md font-semibold leading-5 text-gray-400">Brandon Hicks</p> </div> <div class="sm:text-right text-lg lg:text-xl flex space-y-4 sm:space-y-0 sm:space-x-9 content-center mt-3 sm:mt-0 flex-col sm:flex-row"> <a href="https://theworkaround.com/about" class="font-semibold text-gray-700 tracking-tight" title="About Me" key="about">About</a> <a href="https://theworkaround.com/posts" class="font-semibold text-gray-700 tracking-tight" title="View a list of all posts" key="posts">Posts</a> <a href="https://theworkaround.com/projects"" class="font-semibold text-gray-700 tracking-tight" title="Projects I'm working on" key="projects">Projects</a> <a href="https://theworkaround.com/feed.xml" class="flex content-center text-orange-600" title="RSS Feed" key="feed"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="h-5 w-5 self-center text-orange-600" class=" h-5 w-5 self-center text-orange-600" alt="RSS Feed Icon" aria-hidden="true" focusable="false" role="img"> <path d="M4 11a9 9 0 0 1 9 9"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <circle cx="5" cy="19" r="1"></circle> </svg> </a> </div> </nav> <main class="post px-10 sm:px-7 border-0"> <h1>Using UUIDs in Rails</h1> <h3 id="why-use-uuids">Why use UUIDs?</h3> <p>It may seem like a trivial decision at first glance, but using UUIDs can have an intricate effect on your applications design structure. If you are building an application and have an <code class="highlighter-rouge">id:integer</code> column that auto increments with the creation of every item you add to that table you could end up with some sever issues. As applications grow in size we end up having to seperate parts of the application into different servers: a cluster of database servers, background, jobs, cache server, an httpd server, and throw in a few servers for actual application and you’ve got a whole cluster of services to deal with.</p> <p>Lets say you’ve got 3 servers running the actual application, each one chugging along running serveral instances of your web application. Now say it’s a basic CRUD application if you’ve got several instances writing to the database at once you will have a conflict. If you’ve got a table named books and a few rows are being added at once by seperate visitors, you’re auto incrimenting the rows and lets say on each one it creates row id: 72. Now when they combine their information together you’re going to have an issue with inconsistent data trying to overlap.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Raven</span>
<span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">My</span> <span class="no">Side</span> <span class="n">of</span> <span class="n">the</span> <span class="no">Mountain</span>
<span class="ss">id: </span><span class="mi">72</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Giver</span>
</code></pre></div></div> <p>Now if we were inserting these datasets into the different database servers while using UUIDs we may could up with something to the following example below.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">id: </span><span class="mi">898</span><span class="n">f73bc</span><span class="o">-</span><span class="mi">290</span><span class="n">c</span><span class="o">-</span><span class="mi">4427</span><span class="o">-</span><span class="n">b75a</span><span class="o">-</span><span class="mi">68</span><span class="n">f34464e188</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Raven</span>
<span class="ss">id: </span><span class="n">dd126f47</span><span class="o">-</span><span class="n">de45</span><span class="o">-</span><span class="mi">4</span><span class="n">cbe</span><span class="o">-</span><span class="n">aa1c</span><span class="o">-</span><span class="mi">8</span><span class="n">b052693498e</span><span class="p">,</span> <span class="ss">title: </span><span class="no">My</span> <span class="no">Side</span> <span class="n">of</span> <span class="n">the</span> <span class="no">Mountain</span>
<span class="ss">id: </span><span class="mi">479</span><span class="n">af9a8</span><span class="o">-</span><span class="n">c096</span><span class="o">-</span><span class="mf">42e2</span><span class="o">-</span><span class="mi">8</span><span class="n">a29</span><span class="o">-</span><span class="mi">4</span><span class="n">a321cdd5f7c</span><span class="p">,</span> <span class="ss">title: </span><span class="no">The</span> <span class="no">Giver</span>
</code></pre></div></div> <p>UUIDs are simple 128-bit generated values and only consisting of formated using hexadecimal text. Depending on <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Variants_and_versions">how they’re being generated</a> their values are generally a random value that will rarely have a collision value. It’s generally safe to say that you can use a distributed application and have several servers generating rows of data and almost never have the same UUID generated (I’m not saying it can’t happen, it’s just a lot less likely to happen).</p> <h3 id="how-can-i-do-this-is-rails">How can I do this is Rails?</h3> <p>When you are generating models and scaffolds the <code class="highlighter-rouge">id</code> column is usually automatically generated with every table (unless specified), this is a feature build into Rails to make it easier and faster to develop.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="s2">"books"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="s2">"title"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="k">end</span>

<span class="c1"># Generates</span>
<span class="nb">id</span><span class="ss">:integer</span><span class="p">,</span> <span class="no">PRIMARY</span> <span class="no">KEY</span><span class="p">,</span> <span class="n">auto_increment</span>
<span class="n">title</span><span class="ss">:string</span>
<span class="n">created_at</span><span class="ss">:datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
<span class="n">updated_at</span><span class="ss">:datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
</code></pre></div></div> <p>Now depending on what database you are using to test, develop, and deploy you application there are different steps that are required in order to get your application to properly recognize and use the UUID datatype. I have seperated into different sections how I got UUIDs to work in both Postgresql and the SQLite databases.</p> <h3 id="postgresql">Postgresql</h3> <p>The method in order to get uuids to work with Postgres tends to be quite a bit easier (in my opinion), because Postgres has a built in method for generating unique uuids for row ids.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g migration enable_uuid_extension
</code></pre></div></div> <p>In the migration we tell the Postgres database to use the uuid extension, we do this in order to have the database automatically generate UUIDs on the objects creation rather than having the Rails Application generate the UUIDs and adding additional process time to the server.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EnableUuidExtension</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'pgcrypto'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now lets generate a book model and get started on adjusting the migration to allow the application to generate a UUID for the id instead of a basic integer.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="no">Book</span> <span class="n">title</span><span class="ss">:string</span>
</code></pre></div></div> <p>Now we also need to change id: to use the :uuid datatype instead of letting the application automatically assigning it.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">id: :uuid</span>  <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Now access the rails console <code class="highlighter-rouge">rails c</code> in order to verifiy that UUIDs are being generated upon the models object creation. At this point in time the default version of UUID generation used by Rails is <code class="highlighter-rouge">uuid_generate_v4()</code> which seems to be quite sufficient to avoiding collisions.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mf">2.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'The Raven'</span><span class="p">)</span>
<span class="p">(</span><span class="mf">0.4</span><span class="n">ms</span><span class="p">)</span>  <span class="k">BEGIN</span>
  <span class="no">SQL</span> <span class="p">(</span><span class="mf">35.2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">"books"</span> <span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="vg">$1</span><span class="p">,</span> <span class="vg">$2</span><span class="p">,</span> <span class="vg">$3</span><span class="p">)</span> <span class="no">RETURNING</span> <span class="s2">"id"</span>  <span class="p">[[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"The Raven"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:31:03.762157"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"updated_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:31:03.762157"</span><span class="p">]]</span>
   <span class="p">(</span><span class="mf">197.1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">COMMIT</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Book id: "f55ea573-1eec-4053-b7f5-7b693b344da9", title: "The Raven", created_at: "2015-06-13 05:31:03", updated_at: "2015-06-13 05:31:03"&gt;</span>
</code></pre></div></div> <p>If you look closely you will notice that the Book.id is no longer being generated a basic integer, it is not being generating a Hex based text string. As show above: <code class="highlighter-rouge">Book[id]: f55ea573-1eec-4053-b7f5-7b693b344da9</code></p> <h3 id="sqlite">SQLite</h3> <p>To begin using UUIDs with sqlite you will need to install the <a href="https://github.com/jashmenn/activeuuid"><code class="highlighter-rouge">activeuuid</code></a> gem, when using this gem it will save the uuid: as a binary(16) datatype. I haven’t dug around to much into the gem, but it does seem to work quite effectively for it’s purpose.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'activeuuid'</span>  <span class="c1"># https://github.com/jashmenn/activeuuid</span>
</code></pre></div></div> <p>We will now need to adjust the migration to explicity use the uuid: datatype for :id and completely disregard using the default :id dataset and configuration.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># migrations</span>
<span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">uuid</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:primary_key</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>You will also need to include <code class="highlighter-rouge">ActiveUUID::UUID</code> in your model to enable UUID generation, you will need to specify a <code class="highlighter-rouge">natural_key</code> to supply a dataset in order to generate a UUID. If this step is not included the application will throw a heap of errors about the books.id using an invalid uuid datatype.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">ActiveUUID</span><span class="o">::</span><span class="no">UUID</span>
  <span class="n">natural_key</span> <span class="ss">:created_at</span>
<span class="k">end</span>
</code></pre></div></div> <p>Upon creating a book object, you should recieve output with something similar to the example shown below.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mf">2.2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'The Raven'</span><span class="p">)</span>
   <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">begin</span> <span class="n">transaction</span>
  <span class="no">SQL</span> <span class="p">(</span><span class="mf">0.5</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">"books"</span> <span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="sc">?,</span> <span class="p">?,</span> <span class="sc">?,</span> <span class="p">?)</span>  <span class="p">[[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"&lt;16 bytes of binary data&gt;"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"The Raven"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:57:45.728134"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"updated_at"</span><span class="p">,</span> <span class="s2">"2015-06-13 05:57:45.728134"</span><span class="p">]]</span>
   <span class="p">(</span><span class="mf">3.4</span><span class="n">ms</span><span class="p">)</span>  <span class="n">commit</span> <span class="n">transaction</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Book id: #&lt;UUID:0x3feef3549684 UUID:a5093dd9-cb33-5783-b01c-0d0d381490f1&gt;, title: "The Raven", created_at: "2015-06-13 05:57:45", updated_at: "2015-06-13 05:57:45"&gt;</span>
</code></pre></div></div> <h4 id="updated-08272019">Updated: 08/27/2019</h4> <p>The previous method used the <code class="highlighter-rouge">uuid-ossp</code> extension which relies on <code class="highlighter-rouge">uuid_generate_v4</code> to generate UUIDs. The recommended method <code class="highlighter-rouge">pgcrypto</code> uses the Postgres function <code class="highlighter-rouge">gen_random_uuid</code> to generate UUIDs, this method generates UUIDs faster and with better collision prevention.</p> <hr/> <h4 id="resources">Resources</h4> <ul> <li><a href="https://github.com/jashmenn/activeuuid">activeuuid</a></li> <li><a href="http://www.postgresql.org/docs/9.3/static/datatype-uuid.html">PostgreSQL UUID type</a></li> <li><a href="http://www.postgresql.org/docs/9.3/static/uuid-ossp.html">PostgreSQL uuid-ossp extensions</a></li> </ul> </main> <footer class="space-y-3 text-sm text-center"> <p> Contact me at <a href="mailto:tarellel@gmail.com">tarellel@gmail.com</a> <p/> <p> &copy; 2022 Brandon Hicks - All rights reserved </p> </footer> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41384218-1"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-41384218-1');
    </script> </body> </html>