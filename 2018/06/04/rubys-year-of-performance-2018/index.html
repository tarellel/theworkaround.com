<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="Content-Language" content="en"> <title>Ruby&#39;s Year of Performance (2018) | TheWorkAround</title> <meta property="og:title" content="Ruby’s Year of Performance (2018)"/> <meta name="author" content="Brandon"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta property="og:description" content="The infinite ramblings and ideas of Brandon Hicks"/> <link rel="canonical" href="https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018/"/> <meta property="og:url" content="https://theworkaround.com/2018/06/04/rubys-year-of-performance-2018/"/> <meta property="og:site_name" content="TheWorkAround"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2018-06-04T00:00:00+00:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Ruby’s Year of Performance (2018)"/> <link type="application/atom+xml" rel="alternate" href="https://theworkaround.com/feed.xml" title="TheWorkAround"/> <meta name="author" content="Brandon Hicks"> <meta name="description" content="The infinite ramblings and ideas of Brandon Hicks"/> <meta name="generator" content="Bridgetown"> <meta name="referrer" content="no-referrer-when-downgrade"> <meta name="robots" content="index, follow"> <link rel="preload" href="/_bridgetown/static/index.UPVOJSIG.css" as="style"> <link rel="preload" href="/_bridgetown/static/index.KL3TZR4T.js" as="script"> <link rel="preconnect" href="/" crossorigin> <link rel="preconnect" href="https://rsms.me/inter/inter.css" crossorigin> <link rel="dns-prefetch" href="https://www.googletagmanager.com/"> <link rel="dns-prefetch" href="https://www.google-analytics.com/"> <link rel="dns-prefetch" href="https://ajax.googleapis.com/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link rel="stylesheet" href="/_bridgetown/static/index.UPVOJSIG.css" data-turbo-track="reload"/> <script src="/_bridgetown/static/index.KL3TZR4T.js" data-turbo-track="reload" defer></script> <link href="https://theworkaround.com/sitemap.xml" rel="sitemap" title="Sitemap" type="application/xml"> <link href="https://theworkaround.com/humans.txt" rel="author" type="text/plain"> <link rel="manifest" href="https://theworkaround.com/site.webmanifest"> <link rel="me" href="https://theworkaround.com/" type="text/html"> <link rel="me" href="https://github.com/tarellel"> <link rel="me" href="https://twitter.com/tarellel"> <meta name="theme-color" content="#4cb8c4"> </head> <body class="post antialiased min-h-full font-inter font-normal leading-normal bg-white text-gray-400"> <nav class="border-t-12 border-cyan-600 py-3 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4" role="navigation" aria-label="Main"> <div class="text-left"> <h3 class="text-3xl font-extrabold text-gray-600"> <a href="/" class="text-gray-600" title="Goto /" key="home">TheWorkAround</a> </h3> <p class="text-md font-semibold leading-5 text-gray-400">Brandon Hicks</p> </div> <div class="sm:text-right text-lg lg:text-xl flex space-y-4 sm:space-y-0 sm:space-x-9 content-center mt-3 sm:mt-0 flex-col sm:flex-row"> <a href="https://theworkaround.com/about" class="font-semibold text-gray-700 tracking-tight" title="About Me" key="about">About</a> <a href="https://theworkaround.com/posts" class="font-semibold text-gray-700 tracking-tight" title="View a list of all posts" key="posts">Posts</a> <a href="https://theworkaround.com/projects"" class="font-semibold text-gray-700 tracking-tight" title="Projects I'm working on" key="projects">Projects</a> <a href="https://theworkaround.com/feed.xml" class="flex content-center text-orange-600" title="RSS Feed" key="feed"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className="h-5 w-5 self-center text-orange-600" class=" h-5 w-5 self-center text-orange-600" alt="RSS Feed Icon" aria-hidden="true" focusable="false" role="img"> <path d="M4 11a9 9 0 0 1 9 9"></path> <path d="M4 4a16 16 0 0 1 16 16"></path> <circle cx="5" cy="19" r="1"></circle> </svg> </a> </div> </nav> <main class="post px-10 sm:px-7 border-0"> <h1>Ruby&#39;s Year of Performance (2018)</h1> <p>Many people claim Ruby is no longer relevant and quite a few people have moved on to Elixir, Go, Rust, and Node. This is because Ruby was not originally built for speed, it was built for ease of use. It does have its limitations and Rails is a monstrosity with all it’s services, workers, etc. But I’ve never had an issue with this, I started using Ruby because of its ease of use. I can from a world of using PHP and ugly spaghetti code to Ruby where coding is more of a thing of art.</p> <p>But 2018 has been a big year for Ruby releases and trying to meet their <a href="https://blog.heroku.com/ruby-3-by-3">3x3</a> performance goals (<a href="https://developers.redhat.com/blog/2018/03/22/ruby-3x3-performance-goal/">RedHat Writeup</a>). And in the last year alone, <a href="https://twitter.com/tenderlove">Arron Patterson (tenderlove)</a> and various contributors have made amazing advances in improving Ruby’s performance. And the addition of a <a href="https://www.ruby-lang.org/en/news/2018/05/31/ruby-2-6-0-preview2-released/">JIT compiler</a> to Ruby is no ease feat that looks like it will also have a HUGE effect on Ruby to regain some ground and no longer be known as a “slow language”. I admit <a href="https://github.com/oracle/truffleruby">Ruby Truffle</a> has some extreme potential to improve Rubys performance using the <a href="https://www.graalvm.org/">GraalVM</a> but since Oracle does have a tendency to take people to court and suing them, for using their various technological components.</p> <p>Another modification that I have found that dramatically improves performance and reduces memory usage is by adding <a href="http://jemalloc.net/">jemalloc</a>. By default, the MRI version uses the glibc memalloc library.</p> <p>To use jemalloc with ruby lets first install the library, so we can use it when compiling out ruby binaries.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OSx</span>
brew <span class="nb">install </span>jemalloc

<span class="c"># Ubuntu/Debian</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>libjemalloc1 libjemalloc-dev
</code></pre></div></div> <p>Many of people prefer <a href="https://github.com/rbenv/ruby-build">ruby-build</a> for compiling new ruby versions but I prefer <a href="https://rvm.io/">RVM</a> because of it’s ease of use. Now to compile with jemmalloc, we need to add the flags for RVM to compile using the jemalloc library.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm <span class="nb">install </span>2.5 <span class="nt">-C</span> <span class="nt">--with-jemalloc</span> <span class="nt">--autolibs</span><span class="o">=</span>disable
</code></pre></div></div> <p>I tend to use the <a href="https://fishshell.com/">Fish</a> shell, it has dramatically increased my productivity with its ease of use, auto completion libraries, and great features. So to make compiling a new RVM instance easier I created a function titled <code class="highlighter-rouge">rvm_install</code> so now when I want to compile a new Ruby version with the jemalloc flag I issue a command similar to the following <code class="highlighter-rouge">rvm_install 2.6</code> and wait. Below is a copy of the function I created, I know I should probably issue some validation to verify the value of the argument, but I’m the only one using this on my computer and it’s works wonders for what I need it for.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install the specified Ruby version through RVM, with the jemalloc library included</span>
<span class="k">function </span>rvm_install
  <span class="c"># verify a version number was specified</span>
  <span class="k">if </span>count <span class="nv">$argv</span> <span class="o">&gt;</span> /dev/null
    <span class="nb">echo</span> <span class="s2">"Installing Ruby-</span><span class="nv">$argv</span><span class="s2"> with jemalloc"</span>
    rvm <span class="nb">install</span> <span class="nv">$argv</span> <span class="nt">-C</span> <span class="nt">--with-jemalloc</span>
  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Please specify a version to install."</span>
  end
end
</code></pre></div></div> <p>Now lets take a look at a few Ruby versions to test how well they perform with and without jemalloc. Sam Saffron’s <a href="https://github.com/SamSaffron/allocator_bench/blob/master/stress_mem.rb">stress test</a> is a great way to compare performance gains and memory allocation. And let me reiterate that I didn’t just run this test a single time and compare the results. These use the averages after running each stress test several times.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Results for Ruby_v2.5.0p0</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">9.542045</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">137860</span>

<span class="c1"># Ruby_v2.5.0p0 with jemmalloc</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">7.420393</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">129616</span>

<span class="no">Faster</span> <span class="n">w</span><span class="o">/</span><span class="no">Jemalloc</span><span class="p">:</span>
<span class="mf">0.222347725251767</span> <span class="o">==&gt;</span> <span class="mi">22</span><span class="o">%</span> <span class="n">faster</span>


<span class="c1"># Ruby_v2.6.0-preview2 with jemalloc</span>
<span class="no">Duration</span><span class="p">:</span> <span class="mf">6.743956</span>
<span class="no">RSS</span><span class="p">:</span> <span class="mi">144108</span>

<span class="c1"># Faster than 2.5</span>
<span class="mf">0.09115918792980371</span> <span class="o">==&gt;</span> <span class="mi">9</span><span class="o">%</span> <span class="n">faster</span>
</code></pre></div></div> <p>As you can see, just adding jemalloc to MRI ruby adds quite a noticeable performance gain. And even when not using a different memory allocator, each new Ruby release has had quite a significant impact on building on the languages potential.</p> <p>~ <strong>NOTE:</strong> These tests are performed on a MBP with OSx 10.12, a 2.2ghz i7, 16GB of RAM, and a SSD. So the results may vary from device to device.</p> </main> <footer class="space-y-3 text-sm text-center"> <p> Contact me at <a href="mailto:tarellel@gmail.com">tarellel@gmail.com</a> <p/> <p> &copy; 2004 - 2023 Brandon Hicks - All rights reserved.<br> Content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons 4.0 License</a>.<br> Code samples and snippets are licensed under the <a href="https://github.com/tarellel/theworkaround.com/blob/main/LICENSE">MIT License</a> </p> </footer> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41384218-1"></script> <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-41384218-1');
    </script> </body> </html>